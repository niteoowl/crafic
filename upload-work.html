<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFIQ - 작품 업로드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Pretendard Web Font Definitions */
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-SemiBold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Bold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-ExtraBold.woff') format('woff');
            font-weight: 800;
            font-style: normal;
        }

        /* Base font application */
        body {
            font-family: 'Pretendard', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure full viewport height */
            background-color: #ffffff; /* Changed to white */
            color: #333;
        }

        /* Custom style for dropdown arrow rotation */
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition-property: transform;
            transition-duration: 300ms;
            transition-timing-function: ease-in-out;
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212; /* Very dark gray/near black */
            color: #e0e0e0; /* Light gray text */
        }
        body.dark-mode header {
            background-color: #1e1e1e; /* Darker header */
            box-shadow: none; /* Remove shadow */
            border-bottom: none; /* Remove border */
        }
        body.dark-mode header a,
        body.dark-mode header button,
        body.dark-mode header span {
            color: #e0e0e0; /* Light text for header */
        }
        body.dark-mode header a.text-teal-500 { /* CRAFIQ logo */
            color: #2dd4bf; /* Teal-400 in dark mode */
        }
        body.dark-mode header button.hover\:bg-teal-50:hover {
            background-color: #2a2a2a; /* Darker hover */
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode header button.border-teal-600 {
            border-color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode header .hover\:text-teal-600:hover {
            color: #2dd4bf; /* Teal-400 */
        }
        /* Sections/Cards in dark mode */
        body.dark-mode .bg-white.border { /* Apply to sections with border */
            background-color: #1e1e1e; /* Darker card background */
            border-color: #3a3a3a; /* Darker border */
            box-shadow: none; /* Ensure no shadow */
        }
        body.dark-mode .text-gray-900 {
            color: #e0e0e0; /* Light headings */
        }
        body.dark-mode .text-gray-700 {
            color: #c0c0c0; /* Lighter gray text */
        }
        body.dark-mode .text-gray-500 {
            color: #888888; /* Even lighter gray text */
        }
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #2a2a2a;
            border-color: #3a3a3a;
            color: #e0e0e0;
        }
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: #888888;
        }
        body.dark-mode select option {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        body.dark-mode .bg-gray-200 { /* For tags input button and tag item background */
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        body.dark-mode .hover\:bg-gray-300:hover {
            background-color: #4a4a4a;
        }
        body.dark-mode .tag-item .remove-tag-btn {
            color: #c0c0c0; /* Darker remove tag button icon */
            filter: brightness(1.5); /* Make it slightly brighter for visibility */
        }
        body.dark-mode footer {
            background-color: #121212; /* Dark footer */
            color: #c0c0c0;
        }
        body.dark-mode footer .text-teal-400 {
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode footer .text-gray-600 {
            color: #888888; /* Gray-400 */
        }

        /* Quill editor container styles */
        #editor-container {
            width: 100%;
            height: 400px; /* Increased height for more comfortable writing */
            margin-top: 1.5rem; /* Adjusted margin */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: flex; /* Flex container for toolbar and editor */
            flex-direction: column;
            overflow: hidden; /* To contain Quill's internal overflow */
        }
        body.dark-mode #editor-container {
            border-color: #3a3a3a;
        }

        #editor-container .ql-toolbar {
            background-color: #fcfcfc; /* Toolbar background */
            border-bottom: 1px solid #e0e0e0;
            border-top-left-radius: 8px; /* Match container border radius */
            border-top-right-radius: 8px;
        }
        body.dark-mode #editor-container .ql-toolbar {
            background-color: #2a2a2a;
            border-color: #3a3a3a;
        }

        #editor-container .ql-container {
            flex-grow: 1; /* Editor takes remaining space */
            background-color: #fcfcfc; /* Editor background */
            border: none; /* Remove default Quill border */
            border-bottom-left-radius: 8px; /* Match container border radius */
            border-bottom-right-radius: 8px;
            font-family: 'Pretendard', sans-serif; /* Apply custom font to editor */
            font-size: 1rem; /* Default font size for editor */
            line-height: 1.8; /* Line height for editor */
        }
        body.dark-mode #editor-container .ql-container {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }

        #editor-container .ql-editor {
            padding: 1.5rem; /* Padding inside editor */
            height: 100%; /* Fill container */
            overflow-y: auto; /* Enable scrolling for editor content */
        }
        body.dark-mode #editor-container .ql-editor {
            color: #e0e0e0;
        }

        /* Thumbnail editor specific styles */
        #thumbnail-editor-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            height: 150px; /* Fixed height for thumbnail editor */
            display: flex;
            flex-direction: column;
        }
        body.dark-mode #thumbnail-editor-container {
            border-color: #3a3a3a;
        }
        #thumbnail-editor-container .ql-toolbar {
            background-color: #fcfcfc;
            border-bottom: 1px solid #e0e0e0;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        body.dark-mode #thumbnail-editor-container .ql-toolbar {
            background-color: #2a2a2a;
            border-color: #3a3a3a;
        }
        #thumbnail-editor-container .ql-container {
            flex-grow: 1;
            background-color: #fcfcfc;
            border: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            display: flex; /* Use flex to center content */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }
        body.dark-mode #thumbnail-editor-container .ql-container {
            background-color: #2a2a2a;
        }
        #thumbnail-editor-container .ql-editor {
            padding: 0.5rem; /* Reduced padding */
            text-align: center; /* Center placeholder text */
            display: flex; /* Flex for content within editor */
            align-items: center;
            justify-content: center;
            height: 100%;
            overflow: hidden; /* Prevent scrollbars */
        }
        #thumbnail-editor-container .ql-editor img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensure image fits within bounds */
            border-radius: 4px; /* Apply some border radius to image */
        }
        body.dark-mode #thumbnail-editor-container .ql-editor {
            color: #e0e0e0;
        }


        .page-counter {
            font-size: 0.9rem;
            color: #6b7280;
            text-align: center;
            flex-grow: 1; /* Center the counter */
        }
        body.dark-mode .page-counter {
            color: #a0a0a0;
        }

        /* Button styles for consistency */
        .btn-primary {
            @apply px-4 py-2 rounded-md font-semibold transition-colors duration-200;
        }
        .btn-teal {
            @apply bg-teal-600 text-white hover:bg-teal-700;
        }
        .btn-gray {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        .btn-red {
            @apply bg-red-500 text-white hover:bg-red-600;
        }
        .btn-blue {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }

        /* Page preview thumbnails */
        .page-thumbnails-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-bottom: 1rem; /* Add some padding at the bottom */
            overflow-x: auto; /* Allow horizontal scrolling if many pages */
        }
        .page-thumbnail {
            width: 100px; /* Fixed width for thumbnails */
            height: 120px; /* Fixed height for thumbnails */
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #6b7280;
            background-color: #fcfcfc;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0; /* Prevent shrinking */
        }
        body.dark-mode .page-thumbnail {
            background-color: #2a2a2a;
            border-color: #3a3a3a;
            color: #a0a0a0;
        }
        .page-thumbnail:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .page-thumbnail.active {
            border-color: #2dd4bf; /* Teal border for active page */
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.4); /* Teal glow */
            font-weight: bold;
            color: #2dd4bf; /* Teal text for active page */
        }
        body.dark-mode .page-thumbnail.active {
            border-color: #2dd4bf;
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.4);
            color: #2dd4bf;
        }
        .page-thumbnail-number {
            margin-top: 0.5rem;
            font-weight: bold;
        }
        /* New style for the book controls wrapper */
        .editor-controls-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem; /* Space between buttons */
            padding: 1rem 0; /* Vertical padding */
            margin-top: 1.5rem; /* Space from the editor */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .editor-controls-wrapper .btn-primary {
            min-width: 120px; /* Ensure buttons have a minimum width */
            justify-content: center; /* Center content within buttons */
        }

        /* Styles for thumbnail content (image or text) */
        .page-thumbnail .page-thumbnail-content-wrapper {
            width: 100%;
            height: calc(100% - 24px); /* Adjust height to make space for page number */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .page-thumbnail .page-thumbnail-content-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures image covers the area without distortion */
            border-radius: 4px; /* Inherit from parent or specify */
        }
        .page-thumbnail .page-thumbnail-text-content {
            padding: 0.5rem;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Show 2 lines of text */
            -webkit-box-orient: vertical;
            white-space: normal;
            line-height: 1.2;
            font-size: 0.7rem; /* Smaller font for snippet */
            color: inherit; /* Ensure text color adapts to dark mode */
        }

        /* Tabs for Upload/Manage */
        #main-tabs-container {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 2rem;
            width: 100%;
        }
        body.dark-mode #main-tabs-container {
            border-bottom-color: #3a3a3a;
        }
        .main-tab-button {
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            flex-grow: 1; /* Distribute space evenly */
            text-align: center;
        }
        .main-tab-button.active {
            color: #10b981;
            border-bottom-color: #10b981;
        }
        .main-tab-button:hover:not(.active) {
            color: #14b8a6;
        }
        body.dark-mode .main-tab-button {
            color: #a0a0a0;
        }
        body.dark-mode .main-tab-button.active {
            color: #2dd4bf;
            border-bottom-color: #2dd4bf;
        }
        body.dark-mode .main-tab-button:hover:not(.active) {
            color: #4fd1c5;
        }

        /* My Works List Styling */
        .my-work-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
            background-color: #fcfcfc;
            transition: all 0.2s ease-in-out;
        }
        body.dark-mode .my-work-item {
            background-color: #2a2a2a;
            border-color: #3a3a3a;
        }
        .my-work-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }
        body.dark-mode .my-work-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .my-work-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        .my-work-info {
            flex-grow: 1;
        }
        .my-work-title {
            font-weight: 700;
            font-size: 1.125rem; /* text-lg */
            color: #1a202c;
            margin-bottom: 0.25rem;
        }
        body.dark-mode .my-work-title {
            color: #e0e0e0;
        }
        .my-work-meta {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280;
        }
        body.dark-mode .my-work-meta {
            color: #a0a0a0;
        }
        .my-work-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .my-work-actions .btn-primary {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="min-h-screen bg-white text-gray-800">

    <header id="main-header" class="fixed top-0 left-0 w-full z-50 py-3 transition-all duration-500 ease-in-out bg-white">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-extrabold transition-colors duration-500 text-teal-500">
                CRAFIQ
            </a>

            <nav class="hidden md:flex space-x-6">
                <a href="about.html" class="text-sm font-semibold transition-colors duration-500 text-gray-700 hover:text-teal-600">
                    소개
                </a>
                <a href="#" class="text-sm font-semibold transition-colors duration-500 text-gray-700 hover:text-teal-600">
                    인기작품
                </a>
                <a href="author.html" class="text-sm font-semibold transition-colors duration-500 text-gray-700 hover:text-teal-600">
                    작가 페이지
                </a>
                <a href="#" class="text-sm font-semibold transition-colors duration-500 text-gray-700 hover:text-teal-600">
                    커뮤니티
                </a>
            </nav>

            <div class="flex items-center space-x-4">
                <button class="transition-colors duration-500 text-gray-600 hover:text-teal-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                </button>
                <div id="auth-section" class="flex items-center space-x-4">
                    <button id="login-signup-btn" class="px-4 py-2 rounded-full text-sm font-semibold transition-all duration-500 text-teal-600 border border-teal-600 hover:bg-teal-50">
                        로그인/회원가입
                    </button>
                    <div id="user-info-display" class="relative hidden items-center space-x-1">
                        <span id="user-nickname" class="text-sm font-semibold text-gray-700"></span>
                        <button id="dropdown-toggle-btn" class="cursor-pointer p-1 rounded-full hover:bg-gray-100 transition-colors">
                            <svg id="dropdown-arrow-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-700 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="user-dropdown-menu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden z-20">
                            <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">내 프로필</a>
                            <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">설정</a>
                            <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                로그아웃
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 pt-24">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">작품 관리</h1>
        <p class="text-center text-gray-600 mb-10">작품을 업로드하거나 기존 작품을 관리하세요.</p>

        <div id="main-tabs-container">
            <button class="main-tab-button active" data-tab="upload">작품 업로드</button>
            <button class="main-tab-button" data-tab="manage">내 작품 관리</button>
        </div>

        <div id="upload-tab-content" class="main-tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-2">
                    <section class="bg-white p-8 rounded-lg border border-gray-300">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">기본 정보</h2>
                        <p class="text-gray-600 mb-6">작품의 기본 정보를 입력해 주세요</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="work-title" class="block text-sm font-medium text-gray-700 mb-2">작품 제목 <span class="text-red-500">*</span></label>
                                <input type="text" id="work-title" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="작품 제목을 입력하세요">
                            </div>
                            <div>
                                <label for="work-type" class="block text-sm font-medium text-gray-700 mb-2">작품 유형 <span class="text-red-500">*</span></label>
                                <select id="work-type" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 bg-white">
                                    <option value="novel">소설</option>
                                    <option value="webtoon">웹툰</option>
                                </select>
                            </div>
                            <div>
                                <label for="work-genre" class="block text-sm font-medium text-gray-700 mb-2">장르 <span class="text-red-500">*</span></label>
                                <select id="work-genre" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 bg-white">
                                    <option value="">장르를 선택하세요</option>
                                    <option value="fantasy">판타지</option>
                                    <option value="romance">로맨스</option>
                                    <option value="action">액션</option>
                                    <option value="drama">드라마</option>
                                    <option value="thriller">스릴러</option>
                                </select>
                            </div>
                            <div>
                                <label for="age-rating" class="block text-sm font-medium text-gray-700 mb-2">연령 등급</label>
                                <select id="age-rating" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 bg-white">
                                    <option value="">연령 등급을 선택하세요</option>
                                    <option value="all">전체 이용가</option>
                                    <option value="12">12세 이용가</option>
                                    <option value="15">15세 이용가</option>
                                    <option value="18">18세 이용가</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-6">
                            <label for="work-introduction" class="block text-sm font-medium text-gray-700 mb-2">작품 소개 <span class="text-red-500">*</span></label>
                            <textarea id="work-introduction" rows="5" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="작품에 대한 간단한 소개를 작성해 주세요"></textarea>
                        </div>

                        <div class="mt-6">
                            <label for="work-tags" class="block text-sm font-medium text-gray-700 mb-2">태그</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="tag-input" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="태그를 입력하세요">
                                <button id="add-tag-btn" class="p-3 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                </button>
                            </div>
                            <div id="tags-container" class="flex flex-wrap gap-2 mt-3">
                                </div>
                        </div>
                    </section>

                    <section id="content-creation-section" class="bg-white p-8 rounded-lg border border-gray-300 mt-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6"><span id="content-type-title">소설</span> 내용 작성 (<span id="novel-page-count-display"></span>페이지)</h2>
                        <p class="text-gray-600 mb-6" id="content-type-description">책처럼 페이지별로 소설을 작성해 보세요</p>

                        <div id="editor-container"></div>

                        <div class="editor-controls-wrapper">
                            <button id="prev-page-btn" class="btn-gray btn-primary flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                                이전 페이지
                            </button>
                            <span id="page-counter" class="page-counter">1 / 1 페이지</span>
                            <button id="add-page-btn" class="btn-teal btn-primary flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                페이지 추가
                            </button>
                            <button id="delete-page-btn" class="btn-red btn-primary flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 6 6 18"></path>
                                    <path d="M6 6 18 18"></path>
                                </svg>
                                삭제
                            </button>
                            <button id="next-page-btn" class="btn-gray btn-primary flex items-center">
                                다음 페이지
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                        </div>

                        <div class="flex justify-center space-x-4 mt-6">
                            <button id="save-page-btn" class="btn-blue btn-primary flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    <polyline points="7 3 7 8 15 8"></polyline>
                                </svg>
                                페이지 저장
                            </button>
                        </div>

                        <div id="page-thumbnails-container" class="page-thumbnails-container">
                            </div>
                    </section>
                </div>

                <div class="md:col-span-1">
                    <section class="bg-white p-8 rounded-lg border border-gray-300 mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">썸네일</h2>
                        <p class="text-gray-600 mb-6">작품을 대표할 이미지를 업로드하거나 붙여넣어 주세요.</p>
                        <div id="thumbnail-editor-container"></div>
                        <p class="text-xs text-gray-500 mt-2">썸네일은 첫 번째 이미지로 사용됩니다. (파일 크기에 따라 업로드 시간이 길어질 수 있습니다.)</p>
                    </section>

                    <section class="bg-white p-8 rounded-lg border border-gray-300">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">발행 설정</h2>
                        <div>
                            <label for="public-setting" class="block text-sm font-medium text-gray-700 mb-2">공개 설정</label>
                            <select id="public-setting" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500 bg-white">
                                <option value="public">전체 공개</option>
                                <option value="private">비공개</option>
                                <option value="draft">임시 저장</option>
                            </select>
                        </div>
                    </section>
                </div>
            </div>

            <div class="flex justify-center mt-10">
                <button id="upload-work-btn" class="px-8 py-4 bg-teal-600 text-white font-bold rounded-md text-lg hover:bg-teal-700 transition-colors duration-300 flex items-center justify-center">
                    <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span id="upload-button-text">작품 업로드</span>
                    <svg id="loading-spinner" class="animate-spin h-6 w-6 text-white ml-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="manage-tab-content" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">내 작품 목록</h2>
            <div id="my-works-list" class="space-y-4">
                <p class="text-gray-500 text-center">작품을 불러오는 중...</p>
            </div>
            <p id="no-works-message" class="text-gray-500 text-center mt-4 hidden">아직 업로드한 작품이 없습니다.</p>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-300 py-10 px-4 mt-12">
        <div class="container mx-auto text-center">
            <div class="mb-4">
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">이용약관</a>
                <span class="text-gray-600 text-sm">|</span>
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">개인정보처리방침</a>
                <span class="text-gray-600 text-sm">|</span>
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">문의하기</a>
            </div>
            <p class="text-xs">&copy; 2025 Crafiq. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp, query, where, getDocs, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Firebase configuration (replace with your actual config or load from environment)
        const firebaseConfig = JSON.parse(`{"apiKey": "AIzaSyBJFAV4-QMggAW2K1YtpsXIZ5PQ8KJzo9k", "authDomain": "crafiq-a.firebaseapp.com", "projectId": "crafiq-a", "storageBucket": "crafiq-a.firebasestorage.app", "messagingSenderId": "176082460783", "appId": "1:176082460783:web:cd0b594cc803932eaa2d9a", "measurementId": "G-QB84Z9EMZW"}`);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use __app_id if available
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // Initialize Firebase Storage

        // Get DOM elements
        const authSection = document.getElementById('auth-section');
        const loginSignupBtn = document.getElementById('login-signup-btn');
        const userInfoDisplay = document.getElementById('user-info-display');
        const userNicknameSpan = document.getElementById('user-nickname');
        const dropdownToggleBtn = document.getElementById('dropdown-toggle-btn');
        const dropdownArrowIcon = document.getElementById('dropdown-arrow-icon');
        const userDropdownMenu = document.getElementById('user-dropdown-menu');
        const logoutBtn = document.getElementById('logout-btn');
        const mainHeader = document.getElementById('main-header'); // Get the header element

        // Main Tabs elements
        const mainTabButtons = document.querySelectorAll('.main-tab-button');
        const uploadTabContent = document.getElementById('upload-tab-content');
        const manageTabContent = document.getElementById('manage-tab-content');

        // Form elements (Upload Tab)
        const workTitleInput = document.getElementById('work-title');
        const workIntroductionTextarea = document.getElementById('work-introduction');
        const tagInput = document.getElementById('tag-input');
        const addTagBtn = document.getElementById('add-tag-btn');
        const tagsContainer = document.getElementById('tags-container');
        const uploadWorkBtn = document.getElementById('upload-work-btn');
        const uploadButtonText = document.getElementById('upload-button-text');
        const uploadIcon = document.getElementById('upload-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const workTypeSelect = document.getElementById('work-type'); // Added for type checking
        const workGenreSelect = document.getElementById('work-genre');
        const ageRatingSelect = document.getElementById('age-rating');
        const publicSettingSelect = document.getElementById('public-setting');

        // Content creation section elements (unified for novel/webtoon)
        const contentCreationSection = document.getElementById('content-creation-section');
        const contentTypeTitle = document.getElementById('content-type-title');
        const contentTypeDescription = document.getElementById('content-type-description');
        const novelPageCountDisplay = document.getElementById('novel-page-count-display'); // For "소설/웹툰 작성 (X페이지)" title
        const editorContainer = document.getElementById('editor-container'); // Quill will be initialized here
        const pageCounter = document.getElementById('page-counter');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const addPageBtn = document.getElementById('add-page-btn');
        const deletePageBtn = document.getElementById('delete-page-btn');
        const savePageBtn = document.getElementById('save-page-btn');
        const pageThumbnailsContainer = document.getElementById('page-thumbnails-container'); // New thumbnail container

        // Thumbnail editor element
        const thumbnailEditorContainer = document.getElementById('thumbnail-editor-container'); // NEW

        // My Works List elements (Manage Tab)
        const myWorksListContainer = document.getElementById('my-works-list');
        const noWorksMessage = document.getElementById('no-works-message');

        // New elements for novel volume and webtoon series/chapter
        const novelVolumeField = document.createElement('div');
        novelVolumeField.innerHTML = `
            <label for="volume-number" class="block text-sm font-medium text-gray-700 mb-2 mt-6">시리즈 권 번호 (소설, 선택 사항)</label>
            <input type="number" id="volume-number" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" min="1" placeholder="소설 시리즈의 권 번호 (예: 1)">
        `;
        // Insert it after age-rating select
        ageRatingSelect.closest('div').after(novelVolumeField);


        const webtoonSeriesFields = document.createElement('div');
        webtoonSeriesFields.innerHTML = `
            <div class="mt-6">
                <label for="series-title" class="block text-sm font-medium text-gray-700 mb-2">시리즈 제목 (웹툰)</label>
                <input type="text" id="series-title" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="시리즈 제목을 입력하세요 (예: 나의 판타지 웹툰)">
            </div>
            <div class="mt-4">
                <label for="chapter-number" class="block text-sm font-medium text-gray-700 mb-2">챕터 번호 (웹툰)</label>
                <input type="number" id="chapter-number" class="w-full p-3 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" min="1" value="1" placeholder="챕터 번호를 입력하세요 (예: 1)">
            </div>
        `;
        // Insert it after age-rating select, initially hidden
        ageRatingSelect.closest('div').after(webtoonSeriesFields);
        webtoonSeriesFields.classList.add('hidden'); // Initially hidden

        let tags = [];

        let quill; // Main Quill editor instance for content
        let quillThumbnail; // Quill editor instance for thumbnail

        // Quill editor toolbar options for novels (full features)
        const novelQuillToolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['clean'],
            ['link', 'image']
        ];

        // Quill editor toolbar options for webtoons (only image)
        const webtoonQuillToolbarOptions = [
            ['image'] // Only image upload button
        ];

        /**
         * Custom image handler for Quill to upload to Firebase Storage.
         * This handler is used for both content and thumbnail editors.
         * @param {Quill} quillInstance - The Quill editor instance.
         */
        async function quillImageHandler(quillInstance) {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (file) {
                    const range = quillInstance.getSelection(true);
                    // Insert a placeholder image while uploading
                    quillInstance.editor.insertEmbed(range.index, 'image', 'https://placehold.co/150x150/cccccc/ffffff?text=Uploading...');

                    try {
                        // Generate a temporary workId for storage path if it's a new work
                        const tempWorkId = currentWorkId || doc(collection(db, `artifacts/${appId}/public/data/works`)).id;
                        const imageUrl = await uploadFileToStorage(file, `work_content_images/${tempWorkId}/`);
                        console.log("Image uploaded:", imageUrl);

                        // Replace placeholder with actual image URL
                        quillInstance.editor.deleteText(range.index, 1); // Delete placeholder
                        quillInstance.editor.insertEmbed(range.index, 'image', imageUrl);
                        quillInstance.setSelection(range.index + 1); // Move cursor after image
                    } catch (error) {
                        console.error("Error uploading image:", error);
                        showCustomAlert(`이미지 업로드 중 오류가 발생했습니다: ${error.message}`);
                        quillInstance.editor.deleteText(range.index, 1); // Remove placeholder on error
                    }
                }
            };
        }

        /**
         * Uploads a file to Firebase Storage and returns its URL.
         * @param {File} file - The file to upload.
         * @param {string} path - The storage path (e.g., 'thumbnails/' or 'work_content_images/').
         * @returns {Promise<string>} The download URL of the uploaded file.
         */
        async function uploadFileToStorage(file, path) {
            const storageRef = ref(storage, `${path}${file.name}_${Date.now()}`);
            const snapshot = await uploadBytes(storageRef, file);
            return await getDownloadURL(snapshot.ref);
        }

        /**
         * Updates the header's style (shadow and border) based on dark mode.
         */
        function updateHeaderStyle() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            mainHeader.classList.remove('shadow-sm');
            mainHeader.style.borderBottom = 'none'; /* Ensure no border */

            if (isDarkMode) {
                mainHeader.style.backgroundColor = '#1e1e1e';
            } else {
                mainHeader.style.backgroundColor = '#ffffff';
            }
        }

        /**
         * Applies or removes dark mode based on the toggle state.
         * Stores the preference in localStorage.
         */
        function applyDarkModeToPage(isDarkMode) {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            updateHeaderStyle();
        }

        /**
         * Updates the header's authentication section based on user login status.
         * @param {Object|null} user - The Firebase User object or null if logged out.
         */
        async function updateAuthSection(user) {
            if (user) {
                loginSignupBtn.classList.add('hidden');
                authSection.classList.remove('hidden');
                userInfoDisplay.classList.remove('hidden');
                userInfoDisplay.classList.add('flex');

                userNicknameSpan.textContent = '로딩 중...';

                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/userProfiles`, user.uid);
                try {
                    const docSnap = await getDoc(userProfileRef);
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        if (userData.nickname && userData.nickname.trim() !== '') {
                            userNicknameSpan.textContent = userData.nickname;
                        } else {
                            userNicknameSpan.textContent = user.email || '사용자';
                            console.warn("User profile found but nickname is empty or missing, displaying email:", user.uid);
                        }
                    } else {
                        userNicknameSpan.textContent = user.email || '사용자';
                        console.warn("User profile document not found for:", user.uid);
                    }
                } catch (error) {
                    console.error("Error fetching user profile, displaying email:", error);
                    userNicknameSpan.textContent = user.email || '오류';
                }
                // If user is logged in, fetch their works for the manage tab
                if (mainTabButtons[1].classList.contains('active')) { // Only fetch if manage tab is active
                    fetchAndRenderMyWorks();
                }
            } else {
                loginSignupBtn.classList.remove('hidden');
                userInfoDisplay.classList.add('hidden');
                userInfoDisplay.classList.remove('flex');
                userNicknameSpan.textContent = '';
                userDropdownMenu.classList.add('hidden');
                if (dropdownArrowIcon) {
                    dropdownArrowIcon.classList.remove('rotate-180');
                }
                // Clear my works list if logged out
                myWorksListContainer.innerHTML = '<p class="text-gray-500 text-center">로그인 후 작품을 관리할 수 있습니다.</p>';
                noWorksMessage.classList.add('hidden');
            }
        }

        /**
         * Adds a tag to the tags container.
         * @param {string} tagText - The text of the tag to add.
         */
        function addTag(tagText) {
            if (tagText.trim() === '') return;

            const tagDiv = document.createElement('div');
            tagDiv.className = 'tag-item flex items-center bg-gray-200 text-gray-800 text-sm px-3 py-1 rounded-full';
            tagDiv.innerHTML = `
                <span>${tagText}</span>
                <button type="button" class="remove-tag-btn ml-2 text-gray-600 hover:text-gray-900 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;
            tagsContainer.appendChild(tagDiv);

            // Add event listener to remove button
            tagDiv.querySelector('.remove-tag-btn').addEventListener('click', () => {
                tagDiv.remove();
            });
        }

        /**
         * Renders the content of the current page in the Quill editor.
         * Updates page counter and button states.
         */
        function renderCurrentPage() {
            const selectedType = workTypeSelect.value;
            const pagePrefix = selectedType === 'webtoon' ? 'EP.' : 'P.';

            // Load content into Quill editor
            quill.root.innerHTML = novelPages[currentPageIndex];
            pageCounter.textContent = `${currentPageIndex + 1} / ${novelPages.length} ${selectedType === 'webtoon' ? '화' : '페이지'}`;
            novelPageCountDisplay.textContent = novelPages.length; // Update total page count in title

            prevPageBtn.disabled = currentPageIndex === 0;
            nextPageBtn.disabled = currentPageIndex === novelPages.length - 1;
            deletePageBtn.disabled = novelPages.length === 1; // Cannot delete the last page

            renderPageThumbnails(); // Re-render thumbnails on page change
        }

        /**
         * Renders the page thumbnails at the bottom.
         */
        function renderPageThumbnails() {
            pageThumbnailsContainer.innerHTML = ''; // Clear existing thumbnails
            const isWebtoon = workTypeSelect.value === 'webtoon';
            const pagePrefix = isWebtoon ? 'EP.' : 'P.';

            novelPages.forEach((pageContent, index) => {
                const thumbnailDiv = document.createElement('div');
                thumbnailDiv.className = `page-thumbnail ${index === currentPageIndex ? 'active' : ''}`;
                thumbnailDiv.setAttribute('data-page-index', index);

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'page-thumbnail-content-wrapper';

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = pageContent;

                let contentElement;
                const firstImage = tempDiv.querySelector('img');

                if (isWebtoon && firstImage) {
                    contentElement = document.createElement('img');
                    contentElement.src = firstImage.src;
                    contentElement.alt = "Episode Image";
                    contentElement.className = "w-full h-full object-cover rounded-sm";
                    contentElement.onerror = function() { this.onerror=null;this.src='https://placehold.co/100x120/CCCCCC/333333?text=No+Img'; };
                } else {
                    contentElement = document.createElement('div');
                    contentElement.className = 'page-thumbnail-text-content';
                    contentElement.textContent = tempDiv.textContent.trim().substring(0, 50) || '내용 없음';
                }

                contentWrapper.appendChild(contentElement);
                
                const pageNumberDiv = document.createElement('div'); // Corrected: moved declaration before usage
                pageNumberDiv.className = 'page-thumbnail-number';
                pageNumberDiv.textContent = `${pagePrefix}${index + 1}`;
                thumbnailDiv.appendChild(contentWrapper); // Append content wrapper first
                thumbnailDiv.appendChild(pageNumberDiv);

                thumbnailDiv.addEventListener('click', () => {
                    saveCurrentPageContent(); // Save current page before switching
                    currentPageIndex = index;
                    renderCurrentPage();
                });
                pageThumbnailsContainer.appendChild(thumbnailDiv);
            });
        }


        /**
         * Saves the content from the Quill editor to the current page in the array.
         */
        function saveCurrentPageContent() {
            novelPages[currentPageIndex] = quill.root.innerHTML; // Get HTML content from Quill
            // showCustomAlert('페이지 내용이 저장되었습니다!'); // This alert can be annoying on every change
        }

        /**
         * Navigates to the previous page.
         */
        function goToPrevPage() {
            if (currentPageIndex > 0) {
                saveCurrentPageContent(); // Save current page before navigating
                currentPageIndex--;
                renderCurrentPage();
            }
        }

        /**
         * Navigates to the next page.
         */
        function goToNextPage() {
            if (currentPageIndex < novelPages.length - 1) {
                saveCurrentPageContent(); // Save current page before navigating
                currentPageIndex++;
                renderCurrentPage();
            }
        }

        /**
         * Adds a new blank page after the current page.
         */
        function addPage() {
            saveCurrentPageContent(); // Save current page before adding new
            novelPages.splice(currentPageIndex + 1, 0, '<p><br></p>'); // Insert empty HTML paragraph for Quill
            currentPageIndex++; // Move to the new page
            renderCurrentPage();
            showCustomAlert('새 페이지가 추가되었습니다!');
        }

        /**
         * Deletes the current page.
         */
        function deletePage() {
            if (novelPages.length === 1) {
                showCustomAlert('마지막 페이지는 삭제할 수 없습니다.');
                return;
            }
            showCustomConfirm('정말로 현재 페이지를 삭제하시겠습니까?', () => {
                novelPages.splice(currentPageIndex, 1); // Remove current page
                if (currentPageIndex >= novelPages.length) {
                    currentPageIndex = novelPages.length - 1; // Adjust index if last page was deleted
                }
                renderCurrentPage();
                showCustomAlert('페이지가 삭제되었습니다.');
            });
        }

        /**
         * Handles the change in work type selection.
         * Updates content section titles and descriptions, and UI elements.
         */
        function handleWorkTypeChange() {
            const selectedType = workTypeSelect.value;

            if (selectedType === 'novel') {
                contentTypeTitle.textContent = '소설';
                contentTypeDescription.textContent = '책처럼 페이지별로 소설을 작성해 보세요';
                novelVolumeField.classList.remove('hidden'); // Show novel volume field
                webtoonSeriesFields.classList.add('hidden'); // Hide webtoon series fields

                // Re-initialize Quill with full toolbar for novel
                quill.destroy();
                quill = new Quill(editorContainer, {
                    theme: 'snow',
                    modules: {
                        toolbar: {
                            container: novelQuillToolbarOptions,
                            handlers: {
                                image: () => quillImageHandler(quill)
                            }
                        }
                    },
                    placeholder: '현재 페이지의 내용을 작성해 주세요.',
                });
                quill.on('text-change', saveCurrentPageContent); // Re-attach listener

                // Ensure at least one page for novel
                if (novelPages.length === 0 || (novelPages.length === 1 && novelPages[0].trim() === '<p><br></p>')) {
                    novelPages = ['<p>여기에 내용을 작성해 보세요.</p>'];
                }
                currentPageIndex = 0;
                renderCurrentPage();

            } else if (selectedType === 'webtoon') {
                contentTypeTitle.textContent = '웹툰';
                contentTypeDescription.textContent = '각 에피소드 내용을 페이지별로 작성하고 이미지를 추가하세요.';
                novelVolumeField.classList.add('hidden'); // Hide novel volume field
                webtoonSeriesFields.classList.remove('hidden'); // Show webtoon series fields

                // Re-initialize Quill with limited toolbar for webtoon
                quill.destroy();
                quill = new Quill(editorContainer, {
                    theme: 'snow',
                    modules: {
                        toolbar: {
                            container: webtoonQuillToolbarOptions,
                            handlers: {
                                image: () => quillImageHandler(quill)
                            }
                        }
                    },
                    placeholder: '웹툰 이미지를 업로드하세요. (이미지 버튼만 사용 가능)',
                });
                quill.on('text-change', saveCurrentPageContent); // Re-attach listener

                // Ensure at least one page for webtoon
                if (novelPages.length === 0 || (novelPages.length === 1 && novelPages[0].trim() === '<p><br></p>')) {
                    novelPages = ['<p>여기에 에피소드 내용을 작성하고 이미지를 추가하세요.</p>'];
                }
                currentPageIndex = 0;
                renderCurrentPage();
            }
        }

        /**
         * Displays a custom alert message.
         * @param {string} message - The message to display.
         */
        function showCustomAlert(message) {
            const alertModal = document.createElement('div');
            alertModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            alertModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                    <button class="px-6 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors" onclick="this.closest('.fixed').remove()">확인</button>
                </div>
            `;
            document.body.appendChild(alertModal);
        }

        /**
         * Displays a custom confirmation dialog.
         * @param {string} message - The confirmation message.
         * @param {Function} onConfirm - Callback function to execute if confirmed.
         */
        function showCustomConfirm(message, onConfirm) {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                    <div class="flex justify-center space-x-4">
                        <button class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors" onclick="this.closest('.fixed').remove()">취소</button>
                        <button class="px-6 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors" id="confirm-action-btn">확인</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            document.getElementById('confirm-action-btn').addEventListener('click', () => {
                onConfirm();
                confirmModal.remove();
            });
        }

        /**
         * Fetches and renders the list of works uploaded by the current user.
         */
        async function fetchAndRenderMyWorks() {
            myWorksListContainer.innerHTML = '<p class="text-gray-500 text-center">작품을 불러오는 중...</p>';
            noWorksMessage.classList.add('hidden');

            if (!auth.currentUser) {
                myWorksListContainer.innerHTML = '<p class="text-gray-500 text-center">로그인 후 작품을 관리할 수 있습니다.</p>';
                return;
            }

            const userId = auth.currentUser.uid;
            const worksCollectionRef = collection(db, `artifacts/${appId}/public/data/works`);
            const q = query(worksCollectionRef, where('authorId', '==', userId));

            try {
                const querySnapshot = await getDocs(q);
                myWorksListContainer.innerHTML = ''; // Clear loading message

                if (querySnapshot.empty) {
                    noWorksMessage.classList.remove('hidden');
                    return;
                }

                querySnapshot.forEach(docSnapshot => {
                    const work = docSnapshot.data();
                    const workId = docSnapshot.id;
                    const workItem = document.createElement('div');
                    workItem.className = 'my-work-item';
                    workItem.innerHTML = `
                        <img src="${work.thumbnailUrl || 'https://placehold.co/80x80/CCCCCC/333333?text=No+Thumb'}" alt="${work.title}" class="my-work-thumbnail" onerror="this.onerror=null;this.src='https://placehold.co/80x80/CCCCCC/333333?text=No+Thumb';"/>
                        <div class="my-work-info">
                            <h3 class="my-work-title">${work.title}</h3>
                            <p class="my-work-meta">${work.type === 'novel' ? '소설' : '웹툰'} | ${work.genre || '장르 없음'} | ${work.publicSetting === 'public' ? '공개' : '비공개'}</p>
                        </div>
                        <div class="my-work-actions">
                            <button data-work-id="${workId}" class="edit-work-btn btn-blue btn-primary">수정</button>
                            <button data-work-id="${workId}" data-work-title="${work.title}" class="delete-work-btn btn-red btn-primary">삭제</button>
                        </div>
                    `;
                    myWorksListContainer.appendChild(workItem);
                });

                // Attach event listeners to newly created buttons
                myWorksListContainer.querySelectorAll('.edit-work-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const idToEdit = event.target.dataset.workId;
                        window.location.href = `upload-work.html?workId=${idToEdit}`; // Redirect to upload page for editing
                    });
                });

                myWorksListContainer.querySelectorAll('.delete-work-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const idToDelete = event.target.dataset.workId;
                        const titleToDelete = event.target.dataset.workTitle;
                        deleteWork(idToDelete, titleToDelete);
                    });
                });

            } catch (error) {
                console.error("Error fetching my works:", error);
                myWorksListContainer.innerHTML = '<p class="text-red-500 text-center">내 작품을 불러오는 중 오류가 발생했습니다.</p>';
            }
        }

        /**
         * Deletes a work from Firestore.
         * @param {string} workId - The ID of the work to delete.
         * @param {string} workTitle - The title of the work for confirmation message.
         */
        async function deleteWork(workId, workTitle) {
            showCustomConfirm(`정말로 "${workTitle}" 작품을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`, async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/works`, workId));
                    showCustomAlert(`"${workTitle}" 작품이 성공적으로 삭제되었습니다.`);
                    fetchAndRenderMyWorks(); // Re-render the list after deletion
                } catch (error) {
                    console.error("Error deleting work:", error);
                    showCustomAlert(`작품 삭제 중 오류가 발생했습니다: ${error.message}`);
                }
            });
        }


        // Event Listeners
        window.addEventListener('load', async () => {
            // Authenticate with Firebase on load
            try {
                if (initialAuthToken) {
                    console.log("Attempting sign-in with custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token successfully.");
                } else {
                    console.log("No custom token found. User will be unauthenticated unless they log in.");
                }
            } catch (error) {
                console.error("Firebase authentication failed during initial sign-in attempt:", error);
                if (error.code === 'auth/custom-token-mismatch' || error.code === 'auth/invalid-custom-token') {
                    console.warn("Custom token mismatch/invalid. User will remain unauthenticated.");
                } else {
                    showCustomAlert("Firebase 인증에 실패했습니다. 페이지 기능을 사용하려면 다시 시도해주세요.");
                }
                updateAuthSection(null);
            }

            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                applyDarkModeToPage(savedDarkMode === 'true');
            } else {
                updateHeaderStyle();
            }

            // Initialize Main Quill editor
            quill = new Quill(editorContainer, {
                theme: 'snow', // 'bubble' or 'snow'
                modules: {
                    toolbar: {
                        container: novelQuillToolbarOptions, // Default to novel toolbar
                        handlers: {
                            image: () => quillImageHandler(quill)
                        }
                    }
                },
                placeholder: '현재 페이지의 내용을 작성해 주세요.',
            });

            // Initialize Thumbnail Quill editor (NEW)
            quillThumbnail = new Quill(thumbnailEditorContainer, {
                theme: 'snow',
                modules: {
                    toolbar: [['image']] // Only image upload
                },
                placeholder: '썸네일 이미지를 여기에 드래그하거나 붙여넣으세요.',
            });

            // Listen for changes in Main Quill editor to auto-save to local array
            quill.on('text-change', () => {
                saveCurrentPageContent();
            });

            // Load existing work if workId is present in URL
            const urlParams = new URLSearchParams(window.location.search);
            currentWorkId = urlParams.get('workId'); // Get workId for editing

            if (currentWorkId) {
                try {
                    const workDocRef = doc(db, `artifacts/${appId}/public/data/works`, currentWorkId);
                    const workDocSnap = await getDoc(workDocRef);

                    if (workDocSnap.exists()) {
                        const workData = workDocSnap.data();
                        workTitleInput.value = workData.title || '';
                        workTypeSelect.value = workData.type || 'novel';
                        workGenreSelect.value = workData.genre || '';
                        ageRatingSelect.value = workData.ageRating || '';
                        workIntroductionTextarea.value = workData.introduction || '';
                        publicSettingSelect.value = workData.publicSetting || 'public';

                        // Load novel volume or webtoon series/chapter
                        if (workData.type === 'novel') {
                            document.getElementById('volume-number').value = workData.volumeNumber || '';
                        } else { // webtoon
                            document.getElementById('series-title').value = workData.seriesTitle || '';
                            document.getElementById('chapter-number').value = workData.chapterNumber || '1';
                        }

                        // Load thumbnail into thumbnail Quill editor
                        if (workData.thumbnailUrl) {
                            quillThumbnail.root.innerHTML = `<img src="${workData.thumbnailUrl}" alt="Thumbnail"/>`;
                        } else {
                            quillThumbnail.root.innerHTML = '';
                        }

                        // Clear existing tags and add loaded tags
                        tagsContainer.innerHTML = '';
                        if (workData.tags && Array.isArray(workData.tags)) {
                            workData.tags.forEach(tag => addTag(tag));
                        }

                        // Load content pages
                        if (workData.content && Array.isArray(workData.content) && workData.content.length > 0) {
                            novelPages = [...workData.content];
                        } else {
                            novelPages = ['<p>여기에 내용을 작성해 보세요.</p>']; // Default if no content
                        }
                        currentPageIndex = 0;
                        console.log("Work loaded successfully for editing:", workData);
                        uploadButtonText.textContent = '작품 업데이트'; // Change button text for update
                    } else {
                        console.log("No such work found for ID:", currentWorkId);
                        novelPages = ['<p>여기에 내용을 작성해 보세요.</p>']; // Default for new work
                        const workNameParam = urlParams.get('workName') || '';
                        workTitleInput.value = workNameParam;
                    }
                } catch (error) {
                    console.error("Error loading work from Firestore:", error);
                    showCustomAlert("작품을 불러오는 중 오류가 발생했습니다.");
                    novelPages = ['<p>여기에 내용을 작성해 보세요.</p>']; // Default for new work on error
                }
            } else {
                novelPages = ['<p>여기에 내용을 작성해 보세요.</p>']; // Default for new work
                const workNameParam = urlParams.get('workName') || '';
                workTitleInput.value = workNameParam;
            }

            // Call handler to set initial visibility and content based on default/loaded type
            handleWorkTypeChange();
            renderCurrentPage(); // Initial render of the content editor

            // Explicitly scroll to the top of the page after everything is loaded and rendered
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100); // Small delay
        });

        // Firebase Auth State Listener
        onAuthStateChanged(auth, (user) => {
            updateAuthSection(user);
        });

        // Login/Signup Button
        loginSignupBtn.addEventListener('click', () => {
            window.location.href = 'login.html';
        });

        // Dropdown Toggle
        dropdownToggleBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            userDropdownMenu.classList.toggle('hidden');
            if (dropdownArrowIcon) {
                dropdownArrowIcon.classList.toggle('rotate-180');
            }
        });

        // Logout Button
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!userDropdownMenu.contains(event.target) && !dropdownToggleBtn.contains(event.target)) {
                userDropdownMenu.classList.add('hidden');
                if (dropdownArrowIcon) {
                    dropdownArrowIcon.classList.remove('rotate-180');
                }
            }
        });

        // Add tag on button click
        addTagBtn.addEventListener('click', () => {
            const tagText = tagInput.value.trim();
            if (tagText) {
                addTag(tagText);
                tagInput.value = ''; // Clear input
            }
        });

        // Add tag on Enter key press in input field
        tagInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission
                const tagText = tagInput.value.trim();
                if (tagText) {
                    addTag(tagText);
                    tagInput.value = ''; // Clear input
                }
            }
        });

        // Page navigation and management event listeners
        prevPageBtn.addEventListener('click', goToPrevPage);
        nextPageBtn.addEventListener('click', goToNextPage);
        addPageBtn.addEventListener('click', addPage);
        deletePageBtn.addEventListener('click', deletePage);
        savePageBtn.addEventListener('click', saveCurrentPageContent); // Explicit save button

        // Handle work type change event
        workTypeSelect.addEventListener('change', handleWorkTypeChange);

        // Handle work upload button click
        uploadWorkBtn.addEventListener('click', async () => {
            // Check if user is logged in
            if (!auth.currentUser) {
                showCustomAlert('작품을 업로드하려면 로그인해야 합니다.');
                window.location.href = 'login.html'; // Redirect to login page
                return;
            }

            // Show loading state
            uploadButtonText.textContent = '업로드 중...';
            uploadIcon.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            uploadWorkBtn.disabled = true;

            try {
                // Ensure current page content is saved before final upload
                saveCurrentPageContent();

                const workTitle = workTitleInput.value;
                const workType = workTypeSelect.value;
                const workGenre = workGenreSelect.value;
                const ageRating = ageRatingSelect.value;
                const workIntroduction = workIntroductionTextarea.value;
                const publicSetting = publicSettingSelect.value;
                const currentTags = Array.from(tagsContainer.querySelectorAll('.tag-item span')).map(span => span.textContent);

                // Generate a new workId upfront if it's a new work
                let finalWorkId = currentWorkId;
                if (!finalWorkId) {
                    finalWorkId = doc(collection(db, `artifacts/${appId}/public/data/works`)).id;
                }

                // Process thumbnail: upload Base64 to storage or keep existing URL
                let finalThumbnailUrl = '';
                const thumbnailEditorContent = quillThumbnail.root.innerHTML;
                const tempThumbnailDiv = document.createElement('div');
                tempThumbnailDiv.innerHTML = thumbnailEditorContent;
                const thumbnailImgElement = tempThumbnailDiv.querySelector('img');

                if (thumbnailImgElement && thumbnailImgElement.src) {
                    if (thumbnailImgElement.src.startsWith('data:image/')) {
                        const blob = await (await fetch(thumbnailImgElement.src)).blob();
                        const thumbnailFile = new File([blob], `thumbnail_${finalWorkId}.${blob.type.split('/')[1]}`, { type: blob.type });
                        finalThumbnailUrl = await uploadFileToStorage(thumbnailFile, `thumbnails/${finalWorkId}/`);
                        console.log("Thumbnail uploaded to storage:", finalThumbnailUrl);
                    } else {
                        finalThumbnailUrl = thumbnailImgElement.src; // Already a URL, keep it
                    }
                }

                // Validate required fields
                if (!workTitle || !workType || !workGenre || !workIntroduction || !finalThumbnailUrl) {
                    showCustomAlert('모든 필수 입력 항목 (제목, 유형, 장르, 소개, 썸네일)을 채워주세요.');
                    uploadButtonText.textContent = currentWorkId ? '작품 업데이트' : '작품 업로드';
                    uploadIcon.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    uploadWorkBtn.disabled = false;
                    return;
                }

                let contentToUpload;

                // Process content based on work type
                if (workType === 'novel') {
                    if (novelPages.length === 0 || novelPages.every(page => page.trim() === '<p><br></p>' || page.trim() === '')) {
                        showCustomAlert('소설 내용을 한 페이지 이상 작성해주세요.');
                        uploadButtonText.textContent = currentWorkId ? '작품 업데이트' : '작품 업로드';
                        uploadIcon.classList.remove('hidden');
                        loadingSpinner.classList.add('hidden');
                        uploadWorkBtn.disabled = false;
                        return;
                    }
                    // Process images within novel pages
                    contentToUpload = await Promise.all(novelPages.map(async (pageHtml) => {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = pageHtml;
                        const imgElements = tempDiv.querySelectorAll('img');
                        for (const img of imgElements) {
                            if (img.src.startsWith('data:image/')) {
                                const blob = await (await fetch(img.src)).blob();
                                const file = new File([blob], `novel_content_image_${Date.now()}.${blob.type.split('/')[1]}`, { type: blob.type });
                                img.src = await uploadFileToStorage(file, `work_content_images/${finalWorkId}/`);
                            }
                        }
                        return tempDiv.innerHTML;
                    }));

                } else { // webtoon
                    const webtoonHtmlContent = quill.root.innerHTML;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = webtoonHtmlContent;
                    const imgElements = tempDiv.querySelectorAll('img');

                    if (imgElements.length === 0) {
                        showCustomAlert('웹툰은 최소 한 개 이상의 이미지가 필요합니다.');
                        uploadButtonText.textContent = currentWorkId ? '작품 업데이트' : '작품 업로드';
                        uploadIcon.classList.remove('hidden');
                        loadingSpinner.classList.add('hidden');
                        uploadWorkBtn.disabled = false;
                        return;
                    }

                    // For webtoons, content is an array of image URLs
                    contentToUpload = await Promise.all(Array.from(imgElements).map(async (img) => {
                        if (img.src.startsWith('data:image/')) {
                            const blob = await (await fetch(img.src)).blob();
                            const file = new File([blob], `webtoon_image_${Date.now()}.${blob.type.split('/')[1]}`, { type: blob.type });
                            return await uploadFileToStorage(file, `work_content_images/${finalWorkId}/`);
                        } else {
                            return img.src; // Already a URL
                        }
                    }));
                }

                const workData = {
                    title: workTitle,
                    type: workType,
                    genre: workGenre,
                    ageRating: ageRating,
                    introduction: workIntroduction,
                    tags: currentTags,
                    thumbnailUrl: finalThumbnailUrl,
                    publicSetting: publicSetting,
                    content: contentToUpload,
                    authorId: auth.currentUser.uid,
                    authorNickname: userNicknameSpan.textContent,
                    timestamp: serverTimestamp(),
                    views: 0,
                    likes: 0,
                    rating: 0,
                    ratingCount: 0
                };

                // Add type-specific fields
                if (workType === 'novel') {
                    const volumeNumberInput = document.getElementById('volume-number');
                    const volumeNumber = volumeNumberInput.value.trim();
                    if (volumeNumber !== '') {
                        workData.volumeNumber = parseInt(volumeNumber, 10);
                    }
                } else { // webtoon
                    const seriesTitleInput = document.getElementById('series-title');
                    const chapterNumberInput = document.getElementById('chapter-number');
                    workData.seriesTitle = seriesTitleInput.value.trim();
                    workData.chapterNumber = parseInt(chapterNumberInput.value, 10);
                }

                if (currentWorkId) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/works`, finalWorkId), workData, { merge: true });
                    console.log("Document updated with ID: ", finalWorkId);
                    showCustomAlert('작품이 성공적으로 업데이트되었습니다!');
                } else {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/works`, finalWorkId), workData);
                    console.log("Document written with ID: ", finalWorkId);
                    showCustomAlert('작품이 성공적으로 업로드되었습니다!');
                }
                
                // Redirect to the manage tab after successful upload/update
                window.location.href = 'upload-.html?tab=manage';

            } catch (error) {
                console.error("작품 업로드/업데이트 중 오류 발생:", error);
                showCustomAlert(`작품 업로드/업데이트에 실패했습니다: ${error.message}`);
            } finally {
                // Hide loading state
                uploadButtonText.textContent = currentWorkId ? '작품 업데이트' : '작품 업로드';
                uploadIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                uploadWorkBtn.disabled = false;
            }
        });

        // Main Tab Switching Logic
        mainTabButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const targetTab = event.target.dataset.tab;

                mainTabButtons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                uploadTabContent.classList.add('hidden');
                manageTabContent.classList.add('hidden');

                if (targetTab === 'upload') {
                    uploadTabContent.classList.remove('hidden');
                    // Reset form when switching to upload tab, unless editing
                    if (!currentWorkId) {
                        resetUploadForm();
                    }
                } else if (targetTab === 'manage') {
                    manageTabContent.classList.remove('hidden');
                    if (auth.currentUser) {
                        fetchAndRenderMyWorks(); // Fetch works only when user is logged in
                    } else {
                        myWorksListContainer.innerHTML = '<p class="text-gray-500 text-center">로그인 후 작품을 관리할 수 있습니다.</p>';
                        noWorksMessage.classList.add('hidden');
                    }
                }
                // Always scroll to top when switching tabs
                window.scrollTo(0, 0);
            });
        });

        // Function to reset the upload form
        function resetUploadForm() {
            workTitleInput.value = '';
            workTypeSelect.value = 'novel';
            workGenreSelect.value = '';
            ageRatingSelect.value = '';
            workIntroductionTextarea.value = '';
            quillThumbnail.root.innerHTML = ''; // Clear thumbnail editor
            publicSettingSelect.value = 'public';
            tagsContainer.innerHTML = '';
            tags = []; // Clear the tags array
            novelPages = ['<p>이것은 첫 번째 페이지의 내용입니다. 소설을 책처럼 넘기면서 작성해 보세요!</p>'];
            currentPageIndex = 0;
            renderCurrentPage();
            currentWorkId = null; // Clear current work ID
            uploadButtonText.textContent = '작품 업로드'; // Reset button text
            // Reset novel/webtoon specific fields
            document.getElementById('volume-number').value = '';
            document.getElementById('series-title').value = '';
            document.getElementById('chapter-number').value = '1';
            handleWorkTypeChange(); // Ensure correct editor and fields are shown
        }

        // Check URL for tab parameter on load
        const initialTab = urlParams.get('tab');
        if (initialTab === 'manage') {
            document.querySelector('.main-tab-button[data-tab="manage"]').click();
        } else {
            document.querySelector('.main-tab-button[data-tab="upload"]').click();
        }

    </script>
</body>
</html>
