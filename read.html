<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFIQ - 작품 읽기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Pretendard Web Font Definitions */
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-SemiBold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Bold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-ExtraBold.woff') format('woff');
            font-weight: 800;
            font-style: normal;
        }

        /* Base font application */
        body {
            font-family: 'Pretendard', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f4f8; /* Light blue-gray background for the overall page */
            color: #333;
            overflow-y: scroll; /* Ensure scrollbar is always there for consistent layout */
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212; /* Very dark gray/near black */
            color: #e0e0e0; /* Light gray text */
        }
        body.dark-mode #reader-header,
        body.dark-mode #document-footer {
            background-color: #1e1e1e;
            border-color: #3a3a3a;
            box-shadow: none;
        }
        body.dark-mode #reader-header .text-gray-700,
        body.dark-mode #document-footer .text-gray-700 {
            color: #c0c0c0; /* Light gray for icons/text */
        }
        body.dark-mode #reader-header .text-teal-500,
        body.dark-mode #document-footer .text-teal-500 {
            color: #2dd4bf; /* Teal-400 for logo/links */
        }
        body.dark-mode #reader-header .work-title-center {
            color: #e0e0e0;
        }
        body.dark-mode #reader-header .icon-button:hover,
        body.dark-mode #document-footer .icon-button:hover {
            background-color: #2a2a2a;
        }
        body.dark-mode #document-page-container {
            background-color: #1e1e1e;
            box-shadow: none;
            border-color: #3a3a3a;
        }
        body.dark-mode #work-content-display {
            color: #e0e0e0;
        }
        body.dark-mode #work-content-display h1,
        body.dark-mode #work-content-display h2,
        body.dark-mode #work-content-display h3,
        body.dark-mode #work-content-display h4,
        body.dark-mode #work-content-display h5,
        body.dark-mode #work-content-display h6 {
            color: #e0e0e0;
        }
        body.dark-mode #work-content-display p,
        body.dark-mode #work-content-display li {
            color: #c0c0c0;
        }
        body.dark-mode #work-content-display a {
            color: #63b3ed; /* Lighter blue for links in dark mode */
        }
        body.dark-mode .like-button.liked svg {
            fill: #f87171; /* Lighter red for liked icon in dark mode */
        }
        body.dark-mode #settings-modal .bg-white {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        body.dark-mode #settings-modal .text-gray-900 {
            color: #e0e0e0;
        }
        body.dark-mode #settings-modal .text-gray-800 {
            color: #e0e0e0;
        }
        body.dark-mode #settings-modal .text-gray-700 {
            color: #c0c0c0;
        }
        body.dark-mode #settings-modal .bg-gray-200 {
            background-color: #3a3a3a;
        }
        body.dark-mode #settings-modal .hover\:bg-gray-300:hover {
            background-color: #4a4a4a;
        }
        body.dark-mode #settings-modal .form-radio {
            border-color: #6b7280;
            background-color: #2a2a2a;
        }
        body.dark-mode #settings-modal .form-radio:checked {
            background-color: #2dd4bf;
            border-color: #2dd4bf;
        }


        /* Reader Header */
        #reader-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50;
            background-color: #e0f2fe; /* Light blue background */
            border-bottom: 1px solid #d1e9f7;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 0.75rem 1rem; /* py-3 px-4 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        #reader-header .text-gray-700 { /* Default text color for header elements */
            color: #4a5568; /* Tailwind gray-700 */
        }
        #reader-header .text-teal-500 { /* CRAFIQ logo */
            color: #14b8a6; /* Tailwind teal-500 */
        }
        #reader-header .work-title-center {
            flex-grow: 1;
            text-align: center;
            font-weight: 600; /* Semi-bold */
            font-size: 1rem; /* text-base */
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 1rem; /* Add padding to prevent overlap with buttons */
        }
        #reader-header .icon-button {
            padding: 0.5rem;
            border-radius: 9999px; /* rounded-full */
            transition: background-color 0.2s ease-in-out;
        }
        #reader-header .icon-button:hover {
            background-color: #edf2f7; /* gray-100 */
        }
        /* Specific styling for the + and - font buttons */
        #font-size-controls button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px; /* Fixed width for small buttons */
            height: 28px; /* Fixed height for small buttons */
            font-size: 1.25rem; /* Larger font for +/- symbols */
            line-height: 1;
            border-radius: 4px; /* Slightly rounded corners */
            background-color: #f3f4f6; /* gray-100 */
            color: #4a5568; /* gray-700 */
            transition: background-color 0.2s ease-in-out;
        }
        #font-size-controls button:hover {
            background-color: #e5e7eb; /* gray-200 */
        }


        /* Main content area */
        main {
            padding-top: 5rem; /* Space for fixed header */
            padding-bottom: 5rem; /* Space for fixed bottom controls */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            justify-content: flex-start;
            overflow-y: auto; /* Allow main content area to scroll */
        }

        #document-page-container {
            width: 100%;
            max-width: 800px; /* Max width for reading comfort */
            min-height: calc(100vh - 10rem); /* Minimum height to fill space between header/footer */
            background-color: #ffffff; /* White background for the "page" */
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* More prominent shadow */
            margin: 2rem auto; /* Vertical margin to separate from header/footer area */
            padding: 2.5rem 3rem; /* Generous padding for content */
            line-height: 1.8;
            font-size: 1.1rem; /* Default font size */
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* Style for content within the display area (Quill's output) */
        #work-content-display {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; /* Add transition for page turn effect */
        }
        #work-content-display h1, #work-content-display h2, #work-content-display h3, #work-content-display h4, #work-content-display h5, #work-content-display h6 {
            font-family: 'Pretendard', sans-serif;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: bold;
            color: #333; /* Ensure headings are dark in light mode */
        }
        #work-content-display h1 { font-size: 2.25rem; }
        #work-content-display h2 { font-size: 1.875rem; }
        #work-content-display h3 { font-size: 1.5rem; }
        #work-content-display h4 { font-size: 1.25rem; }
        #work-content-display h5 { font-size: 1.125rem; }
        #work-content-display h6 { font-size: 1rem; }
        #work-content-display p {
            margin-bottom: 1em;
            color: #333; /* Ensure paragraphs are dark in light mode */
        }
        #work-content-display strong { font-weight: bold; }
        #work-content-display em { font-style: italic; }
        #work-content-display u { text-decoration: underline; }
        #work-content-display strike { text-decoration: line-through; }
        #work-content-display a {
            color: #2563eb;
            text-decoration: underline;
        }
        #work-content-display ul, #work-content-display ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
            color: #333; /* Ensure lists are dark in light mode */
        }
        #work-content-display li {
            margin-bottom: 0.5em;
        }
        #work-content-display img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1em auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        body.dark-mode #work-content-display img {
            box-shadow: none;
        }
        /* Style for the initial work details on the first page */
        #work-content-display .initial-work-details h1 {
            font-size: 2.5rem; /* Larger title */
            margin-bottom: 0.5rem;
        }
        #work-content-display .initial-work-details p {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 0.5rem;
        }
        body.dark-mode #work-content-display .initial-work-details p {
            color: #a0a0a0;
        }
        #work-content-display .initial-work-details .tag-item {
            background-color: #e0f7fa; /* Lighter teal for tags */
            color: #00796b; /* Darker teal text */
            font-size: 0.8rem;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
        }
        body.dark-mode #work-content-display .initial-work-details .tag-item {
            background-color: #004d40;
            color: #80cbc4;
        }
        #work-content-display .initial-work-details hr {
            border-top: 1px solid #eee;
            margin: 2rem 0;
        }
        body.dark-mode #work-content-display .initial-work-details hr {
            border-color: #3a3a3a;
        }


        /* Document Footer */
        #document-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 50;
            background-color: #e0f2fe; /* Light blue background */
            border-top: 1px solid #d1e9f7;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            padding: 0.75rem 1rem; /* py-3 px-4 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #4a5568;
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        #document-footer .icon-button {
            padding: 0.5rem;
            border-radius: 9999px;
            transition: background-color 0.2s ease-in-out;
        }
        #document-footer .icon-button:hover {
            background-color: #edf2f7;
        }
        .like-button.liked svg {
            fill: #ef4444; /* Red-500 */
            animation: pulse-fill 0.3s ease-out;
        }
        @keyframes pulse-fill {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Book Mode Specific Styles */
        body.book-mode main {
            padding-top: 5rem; /* Same as scroll mode */
            padding-bottom: 5rem; /* Same as scroll mode */
            display: block; /* Override flex-column to allow fixed height on container */
        }

        body.book-mode #document-page-container {
            height: calc(100vh - 10rem); /* Fixed height: viewport height - header height - footer height */
            overflow-y: auto; /* Allow scrolling within the fixed height */
            scroll-snap-type: y mandatory; /* Optional: for snapping to pages */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            margin: 2rem auto; /* Center with margin */
        }

        body.book-mode #work-content-display {
            padding-bottom: 2rem; /* Ensure content doesn't get cut off at the bottom */
            scroll-snap-align: start; /* Optional: for snapping content to top of container */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">

    <header id="reader-header">
        <div class="flex items-center space-x-4">
            <a href="index.html" class="text-xl font-extrabold text-teal-500">
                CRAFIQ Reader
            </a>
            <button id="back-to-detail-btn" class="icon-button text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <button class="icon-button text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
            </button>
            <button id="prev-page-header-btn" class="icon-button text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <span id="page-counter-header" class="text-sm font-semibold text-gray-700">1 / 1</span>
            <button id="next-page-header-btn" class="icon-button text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>

        <div id="work-title-header" class="work-title-center">작품 제목 로딩 중...</div>

        <div class="flex items-center space-x-2">
            <button id="settings-button" class="icon-button text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.22a2 2 0 0 0 .73 2.73l.04.02a2 2 0 0 1 .97 1.73v.44a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.22a2 2 0 0 0 .73 2.73l.04.02a2 2 0 0 1 .97 1.73v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.22a2 2 0 0 0-.73-2.73l-.04-.02a2 2 0 0 1-.97-1.73v-.44a2 2 0 0 0 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.22a2 2 0 0 0-.73-2.73l-.04-.02a2 2 0 0 1-.97-1.73V4a2 2 0 0 0-2-2z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            </button>
            <div id="user-info-display-header" class="relative flex items-center space-x-1">
                <span id="user-nickname-header" class="text-sm font-semibold text-gray-700 hidden md:block"></span>
                <button id="auth-button-header" class="icon-button text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                <div id="user-dropdown-menu-header" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden z-20">
                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">내 프로필</a>
                    <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">설정</a>
                    <button id="logout-btn-header" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        로그아웃
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4">
        <div id="document-page-container">
            <div id="work-content-display">
                <p class="text-gray-500 text-center">작품 내용을 불러오는 중...</p>
            </div>
        </div>
    </main>

    <footer id="document-footer">
        <div class="flex items-center space-x-2">
            <span id="footer-page-info" class="text-gray-700 font-semibold">0 / 0</span>
        </div>
        <div class="flex flex-col items-center flex-grow mx-4">
            <span id="footer-work-title" class="text-gray-700 font-semibold text-center truncate w-full">작품 제목 로딩 중...</span>
            <span id="footer-published-date" class="text-gray-500 text-xs mt-1"></span>
        </div>
        <div class="flex items-center space-x-4">
            <button id="like-button" class="icon-button text-gray-700 flex items-center space-x-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                </svg>
                <span id="work-likes">0</span>
            </button>
            <button class="icon-button text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                    <polyline points="16 6 12 2 8 6"></polyline>
                    <line x1="12" y1="2" x2="12" y2="15"></line>
                </svg>
            </button>
            <button class="icon-button text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>
            <button class="icon-button text-gray-700 hidden md:block"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L9.44 10.6"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
            </button>
            <button class="icon-button text-gray-700 hidden md:block"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path>
                </svg>
            </button>
        </div>
    </footer>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">읽기 설정</h2>

            <div class="flex items-center justify-between mb-4">
                <span class="text-lg font-semibold text-gray-800">다크 모드</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-teal-600"></div>
                </label>
            </div>

            <div class="mb-6">
                <label class="block text-lg font-semibold text-gray-800 mb-2">글자 크기</label>
                <div class="flex items-center justify-center space-x-4">
                    <button id="modal-font-decrease-button" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-gray-700 font-bold text-xl">-</button>
                    <span id="current-font-size-display" class="text-xl font-semibold text-gray-800">1.1rem</span>
                    <button id="modal-font-increase-button" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-gray-700 font-bold text-xl">+</button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-lg font-semibold text-gray-800 mb-2">읽기 모드</label>
                <div class="flex flex-col space-y-2">
                    <label class="inline-flex items-center">
                        <input type="radio" name="reading-mode" value="scroll" id="scroll-mode-radio" class="form-radio text-teal-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">스크롤 모드 (자유롭게 스크롤)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="reading-mode" value="book" id="book-mode-radio" class="form-radio text-teal-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">책 모드 (화면 단위로 보기)</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end">
                <button id="close-settings-modal" class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-md hover:bg-teal-700 transition-colors">
                    닫기
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, increment, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = JSON.parse(`{"apiKey": "AIzaSyBJFAV4-QMggAW2K1YtpsXIZ5PQ8KJzo9k", "authDomain": "crafiq-a.firebaseapp.com", "projectId": "crafiq-a", "storageBucket": "crafiq-a.firebasestorage.app", "messagingSenderId": "176082460783", "appId": "1:176082460783:web:cd0b594cc803932eaa2d9a", "measurementId": "G-QB84Z9EMZW"}`);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentWorkData = null;
        let currentPageIndex = 0;
        let currentUserId = null;
        let hasUserLiked = false; // To track if the current user has liked this work
        let currentFontSize = parseFloat(localStorage.getItem('readerFontSize')) || 1.1; // Default font size in rem
        let currentReadingMode = localStorage.getItem('readingMode') || 'scroll'; // Default reading mode

        // Touch swipe variables
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50; // Minimum pixels to register a swipe

        // Get DOM elements (Header)
        const readerHeader = document.getElementById('reader-header');
        const backToDetailBtn = document.getElementById('back-to-detail-btn'); // New back button
        const workTitleHeader = document.getElementById('work-title-header');
        const pageCounterHeader = document.getElementById('page-counter-header');
        const prevPageHeaderBtn = document.getElementById('prev-page-header-btn');
        const nextPageHeaderBtn = document.getElementById('next-page-header-btn');
        const authButtonHeader = document.getElementById('auth-button-header');
        const userNicknameHeader = document.getElementById('user-nickname-header');
        const userDropdownMenuHeader = document.getElementById('user-dropdown-menu-header');
        const logoutBtnHeader = document.getElementById('logout-btn-header');
        const settingsButton = document.getElementById('settings-button'); // New settings button

        // Get DOM elements (Main Content)
        const documentPageContainer = document.getElementById('document-page-container');
        const workContentDisplay = document.getElementById('work-content-display');

        // Get DOM elements (Footer)
        const documentFooter = document.getElementById('document-footer');
        const footerPageInfo = document.getElementById('footer-page-info');
        const footerWorkTitle = document.getElementById('footer-work-title');
        const footerPublishedDate = document.getElementById('footer-published-date');
        const likeButton = document.getElementById('like-button');
        const likeButtonIcon = likeButton.querySelector('svg');
        const workLikesElement = document.getElementById('work-likes');

        // Get DOM elements (Settings Modal)
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModal = document.getElementById('close-settings-modal');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const modalFontDecreaseButton = document.getElementById('modal-font-decrease-button');
        const modalFontIncreaseButton = document.getElementById('modal-font-increase-button');
        const currentFontSizeDisplay = document.getElementById('current-font-size-display');
        const scrollModeRadio = document.getElementById('scroll-mode-radio');
        const bookModeRadio = document.getElementById('book-mode-radio');
        const readingModeRadios = document.querySelectorAll('input[name="reading-mode"]');


        // Extract workId and pageIndex from URL: Prioritize query parameter, then path segments
        let workId = null;
        let initialPageIndex = 0; // Default to 0

        const urlParams = new URLSearchParams(window.location.search);
        workId = urlParams.get('workId'); // Try to get from query parameter first
        const pageIndexParam = urlParams.get('pageIndex');
        if (pageIndexParam !== null) {
            initialPageIndex = parseInt(pageIndexParam, 10);
            if (isNaN(initialPageIndex) || initialPageIndex < 0) {
                initialPageIndex = 0;
            }
        }

        if (!workId) { // If workId not found in query parameter, try path segments
            const pathSegments = window.location.pathname.split('/');
            // Example paths: /read/workId, /read/workId/pageIndex
            // We look for the segment after 'read'
            const readIndex = pathSegments.indexOf('read');
            if (readIndex !== -1 && readIndex + 1 < pathSegments.length) {
                workId = pathSegments[readIndex + 1];
                if (readIndex + 2 < pathSegments.length) {
                    const pageIndexSegment = pathSegments[readIndex + 2];
                    const parsedPageIndex = parseInt(pageIndexSegment, 10);
                    if (!isNaN(parsedPageIndex) && parsedPageIndex >= 0) {
                        initialPageIndex = parsedPageIndex;
                    }
                }
            }
        }
        currentPageIndex = initialPageIndex; // Set the global current page index

        console.log("Extracted workId:", workId, "initialPageIndex:", initialPageIndex);


        /**
         * Applies or removes dark mode based on the toggle state.
         * Stores the preference in localStorage.
         */
        function applyDarkModeToPage(isDarkMode) {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                darkModeToggle.checked = false;
            }
            localStorage.setItem('darkMode', isDarkMode);
        }

        /**
         * Updates the header's authentication section based on user login status.
         * @param {Object|null} user - The Firebase User object or null if logged out.
         */
        async function updateAuthSection(user) {
            currentUserId = user ? user.uid : null; // Update global userId
            if (user) {
                // User is logged in
                authButtonHeader.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>`; // User icon
                userNicknameHeader.classList.remove('hidden');

                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/userProfiles`, user.uid);
                try {
                    const docSnap = await getDoc(userProfileRef);
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        if (userData.nickname && userData.nickname.trim() !== '') {
                            userNicknameHeader.textContent = userData.nickname;
                        } else {
                            userNicknameHeader.textContent = user.email || '사용자';
                            console.warn("User profile found but nickname is empty or missing, displaying email:", user.uid);
                        }
                    } else {
                        userNicknameHeader.textContent = user.email || '사용자';
                        console.warn("User profile document not found for:", user.uid);
                    }
                } catch (error) {
                    console.error("Error fetching user profile, displaying email:", error);
                    userNicknameHeader.textContent = user.email || '오류';
                }
            } else {
                // User is logged out
                authButtonHeader.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>`; // Login/user icon (can be changed to a distinct login icon if preferred)
                userNicknameHeader.classList.add('hidden');
                userDropdownMenuHeader.classList.add('hidden'); // Hide dropdown if logged out
            }
            // After auth state is known, check like status
            if (currentWorkData && currentUserId) {
                checkUserLikeStatus(currentWorkData.id, currentUserId);
            } else {
                // If not logged in or no work data, ensure like button is not "liked"
                likeButtonIcon.classList.remove('liked');
                likeButtonIcon.setAttribute('fill', 'none');
            }
        }

        /**
         * Renders the current page of the work.
         * @param {string} [direction='none'] - 'prev', 'next', or 'none' for animation direction.
         */
        function renderWorkPage(direction = 'none') {
            if (!currentWorkData || !currentWorkData.content || currentWorkData.content.length === 0) {
                workContentDisplay.innerHTML = '<p class="text-gray-500 text-center">작품 내용을 불러올 수 없습니다.</p>';
                pageCounterHeader.textContent = '0 / 0';
                footerPageInfo.textContent = '0 / 0';
                prevPageHeaderBtn.disabled = true;
                nextPageHeaderBtn.disabled = true;
                return;
            }

            // Ensure currentPageIndex is within bounds
            if (currentPageIndex >= currentWorkData.content.length) {
                currentPageIndex = currentWorkData.content.length - 1;
            }
            if (currentPageIndex < 0) {
                currentPageIndex = 0;
            }

            const pageContent = currentWorkData.content[currentPageIndex];

            // Apply animation if in book mode and a direction is given
            if (currentReadingMode === 'book' && direction !== 'none') {
                workContentDisplay.style.opacity = '0';
                workContentDisplay.style.transform = direction === 'next' ? 'translateX(-20px)' : 'translateX(20px)';

                setTimeout(() => {
                    updateContentAndResetAnimation(pageContent);
                }, 300); // Match CSS transition duration
            } else {
                updateContentAndResetAnimation(pageContent);
            }

            // Update header and footer page counters
            pageCounterHeader.textContent = `${currentPageIndex + 1} / ${currentWorkData.content.length}`;
            footerPageInfo.textContent = `${currentPageIndex + 1} / ${currentWorkData.content.length}`;

            // Update header navigation button states
            prevPageHeaderBtn.disabled = currentPageIndex === 0;
            nextPageHeaderBtn.disabled = currentPageIndex === currentWorkData.content.length - 1;

            // Apply current font size
            workContentDisplay.style.fontSize = `${currentFontSize}rem`;
            currentFontSizeDisplay.textContent = `${currentFontSize.toFixed(1)}rem`; // Update display in modal
        }

        /**
         * Updates the content display and resets animation properties.
         * @param {string} contentHtml - The HTML content for the current page.
         */
        function updateContentAndResetAnimation(contentHtml) {
            // For the first page, display title, author, introduction, tags before content
            if (currentPageIndex === 0) {
                let initialDetailsHtml = `
                    <div class="initial-work-details text-center mb-8">
                        <h1 class="text-gray-900">${currentWorkData.title || '제목 없음'}</h1>
                        <p class="text-gray-700">작가: ${currentWorkData.authorNickname || '알 수 없음'}</p>
                `;
                if (currentWorkData.introduction) {
                    initialDetailsHtml += `<p class="mt-4">${currentWorkData.introduction}</p>`;
                }
                if (currentWorkData.tags && Array.isArray(currentWorkData.tags) && currentWorkData.tags.length > 0) {
                    initialDetailsHtml += `<div class="flex flex-wrap gap-2 justify-center mt-4">`;
                    currentWorkData.tags.forEach(tag => {
                        initialDetailsHtml += `<span class="tag-item">${tag}</span>`;
                    });
                    initialDetailsHtml += `</div>`;
                }
                initialDetailsHtml += `</div><hr>`; // Separator
                workContentDisplay.innerHTML = initialDetailsHtml + contentHtml;
            } else {
                workContentDisplay.innerHTML = contentHtml;
            }

            // Reset transform and fade back in
            workContentDisplay.style.transform = 'translateX(0)';
            workContentDisplay.style.opacity = '1';

            // Scroll to top of the content container if in book mode, or window if scroll mode
            if (currentReadingMode === 'book') {
                documentPageContainer.scrollTo(0, 0);
            } else {
                window.scrollTo(0, 0);
            }
        }


        /**
         * Navigates to the previous page.
         */
        function goToPrevPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                renderWorkPage('prev'); // Pass direction for animation
            }
        }

        /**
         * Navigates to the next page.
         */
        function goToNextPage() {
            if (currentPageIndex < currentWorkData.content.length - 1) {
                currentPageIndex++;
                renderWorkPage('next'); // Pass direction for animation
            }
        }

        /**
         * Adjusts the font size of the work content.
         * @param {number} delta - The amount to change the font size by (e.g., 0.1 for increase, -0.1 for decrease).
         */
        function adjustFontSize(delta) {
            currentFontSize = Math.max(0.8, Math.min(2.0, currentFontSize + delta)); // Limit min/max font size
            workContentDisplay.style.fontSize = `${currentFontSize}rem`;
            currentFontSizeDisplay.textContent = `${currentFontSize.toFixed(1)}rem`;
            localStorage.setItem('readerFontSize', currentFontSize); // Save preference
        }

        /**
         * Applies the selected reading mode CSS classes.
         * @param {string} mode - 'scroll' or 'book'.
         */
        function applyReadingMode(mode) {
            if (mode === 'book' && currentWorkData && currentWorkData.type === 'webtoon') {
                // Webtoons must always be in scroll mode
                document.body.classList.remove('book-mode');
                scrollModeRadio.checked = true; // Ensure scroll mode is selected in UI
                localStorage.setItem('readingMode', 'scroll'); // Force save scroll mode
                currentReadingMode = 'scroll'; // Update global variable
                bookModeRadio.disabled = true; // Disable book mode radio for webtoons
                bookModeRadio.closest('label').style.opacity = '0.5'; // Visually indicate disabled
                showCustomAlert('웹툰은 "책 모드"를 지원하지 않습니다. 스크롤 모드로 전환됩니다.');
            } else {
                if (mode === 'book') {
                    document.body.classList.add('book-mode');
                    bookModeRadio.checked = true;
                } else { // scroll mode
                    document.body.classList.remove('book-mode');
                    scrollModeRadio.checked = true;
                }
                localStorage.setItem('readingMode', mode);
                currentReadingMode = mode;
                bookModeRadio.disabled = false; // Enable book mode radio for novels
                bookModeRadio.closest('label').style.opacity = '1';
            }
        }

        /**
         * Fetches and displays work data from Firestore.
         */
        async function fetchWorkData() {
            if (!workId) {
                workTitleHeader.textContent = '오류: 작품 ID가 없습니다.';
                footerWorkTitle.textContent = '오류: 작품 ID가 없습니다.';
                workContentDisplay.innerHTML = '<p class="text-red-500 text-center">잘못된 접근입니다.</p>';
                return;
            }

            const workDocRef = doc(db, `artifacts/${appId}/public/data/works`, workId);

            // Use onSnapshot for real-time updates
            onSnapshot(workDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    currentWorkData = { id: docSnap.id, ...docSnap.data() };
                    console.log("Work data received:", currentWorkData);

                    workTitleHeader.textContent = currentWorkData.title || '제목 없음';
                    footerWorkTitle.textContent = currentWorkData.title || '제목 없음';
                    workLikesElement.textContent = currentWorkData.likes || 0;

                    // Format and display published date
                    if (currentWorkData.timestamp && currentWorkData.timestamp.toDate) {
                        const date = currentWorkData.timestamp.toDate();
                        footerPublishedDate.textContent = `Published on ${date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}`;
                    } else {
                        footerPublishedDate.textContent = '';
                    }

                    // Enforce reading mode for webtoons
                    if (currentWorkData.type === 'webtoon') {
                        applyReadingMode('scroll'); // Force scroll mode for webtoons
                    } else {
                        applyReadingMode(currentReadingMode); // Apply user's preference
                    }

                    renderWorkPage(); // Render the current page content (initial load, no animation)

                    // Increment views only on initial load, not on subsequent updates from onSnapshot
                    const sessionKey = `viewed_${workId}`;
                    if (!sessionStorage.getItem(sessionKey)) {
                        try {
                            await updateDoc(workDocRef, {
                                views: increment(1)
                            });
                            sessionStorage.setItem(sessionKey, 'true');
                            console.log("Views incremented for work:", workId);
                        } catch (error) {
                            console.error("Error incrementing views:", error);
                        }
                    }

                    // Check user's like status after work data is loaded and user is authenticated
                    if (currentUserId) {
                        checkUserLikeStatus(currentWorkData.id, currentUserId);
                    }

                } else {
                    workTitleHeader.textContent = '작품을 찾을 수 없습니다.';
                    footerWorkTitle.textContent = '작품을 찾을 수 없습니다.';
                    footerPublishedDate.textContent = '';
                    workContentDisplay.innerHTML = '<p class="text-red-500 text-center">해당 작품이 존재하지 않거나 삭제되었습니다.</p>';
                    workLikesElement.textContent = '0';
                    pageCounterHeader.textContent = '0 / 0';
                    footerPageInfo.textContent = '0 / 0';
                    prevPageHeaderBtn.disabled = true;
                    nextPageHeaderBtn.disabled = true;
                    likeButton.disabled = true; // Disable like button if work not found
                    console.error("No such work document!");
                }
            }, (error) => {
                console.error("Error fetching work data:", error);
                workTitleHeader.textContent = '오류 발생';
                footerWorkTitle.textContent = '오류 발생';
                footerPublishedDate.textContent = '';
                workContentDisplay.innerHTML = '<p class="text-red-500 text-center">작품을 불러오는 중 오류가 발생했습니다.</p>';
                pageCounterHeader.textContent = '0 / 0';
                footerPageInfo.textContent = '0 / 0';
                prevPageHeaderBtn.disabled = true;
                nextPageHeaderBtn.disabled = true;
                likeButton.disabled = true; // Disable like button on error
            });
        }

        /**
         * Checks if the current user has liked the work and updates the UI.
         * @param {string} workId - The ID of the work.
         * @param {string} userId - The ID of the current user.
         */
        async function checkUserLikeStatus(workId, userId) {
            const likeDocRef = doc(db, `artifacts/${appId}/public/data/works/${workId}/likes`, userId);
            try {
                const docSnap = await getDoc(likeDocRef);
                hasUserLiked = docSnap.exists();
                updateLikeButtonUI();
            } catch (error) {
                console.error("Error checking like status:", error);
                hasUserLiked = false; // Assume not liked on error
                updateLikeButtonUI();
            }
        }

        /**
         * Updates the like button UI based on `hasUserLiked` state.
         */
        function updateLikeButtonUI() {
            if (hasUserLiked) {
                likeButtonIcon.classList.add('liked');
                likeButtonIcon.setAttribute('fill', 'currentColor'); // Fill the heart
            } else {
                likeButtonIcon.classList.remove('liked');
                likeButtonIcon.setAttribute('fill', 'none'); // Outline the heart
            }
        }

        /**
         * Handles the like/unlike action.
         */
        async function handleLikeUnlike() {
            if (!currentUserId) {
                showCustomAlert('작품에 좋아요를 누르려면 로그인해야 합니다.');
                window.location.href = 'login.html';
                return;
            }
            if (!currentWorkData) {
                console.warn("No work data available to like/unlike.");
                return;
            }

            const workDocRef = doc(db, `artifacts/${appId}/public/data/works`, currentWorkData.id);
            const likeDocRef = doc(db, `artifacts/${appId}/public/data/works/${currentWorkData.id}/likes`, currentUserId);

            try {
                if (hasUserLiked) {
                    // Unlike the work
                    await deleteDoc(likeDocRef);
                    await updateDoc(workDocRef, {
                        likes: increment(-1)
                    });
                    hasUserLiked = false;
                    showCustomAlert('좋아요를 취소했습니다.');
                } else {
                    // Like the work
                    await setDoc(likeDocRef, { userId: currentUserId }); // Can add likedAt: serverTimestamp() here
                    await updateDoc(workDocRef, {
                        likes: increment(1)
                    });
                    hasUserLiked = true;
                    showCustomAlert('작품에 좋아요를 눌렀습니다!');
                }
                updateLikeButtonUI(); // Update UI immediately
            } catch (error) {
                console.error("Error liking/unliking work:", error);
                showCustomAlert(`좋아요 처리 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        /**
         * Displays a custom alert message.
         * @param {string} message - The message to display.
         */
        function showCustomAlert(message) {
            const alertModal = document.createElement('div');
            alertModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            alertModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                    <button class="px-6 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors" onclick="this.closest('.fixed').remove()">확인</button>
                </div>
            `;
            document.body.appendChild(alertModal);
        }

        // Event Listeners
        window.addEventListener('load', async () => {
            // Authenticate with Firebase on load
            try {
                if (initialAuthToken) {
                    console.log("Attempting sign-in with custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token successfully.");
                } else {
                    console.log("No custom token found. User will be unauthenticated unless they log in.");
                }
            } catch (error) {
                console.error("Firebase authentication failed during initial sign-in attempt:", error);
                if (error.code === 'auth/custom-token-mismatch' || error.code === 'auth/invalid-custom-token') {
                    console.warn("Custom token mismatch/invalid. User will remain unauthenticated.");
                } else {
                    showCustomAlert("Firebase 인증에 실패했습니다. 페이지 기능을 사용하려면 다시 시도해주세요.");
                }
                updateAuthSection(null);
            }

            // Load dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                applyDarkModeToPage(savedDarkMode === 'true');
            }

            // Load reading mode preference
            const savedReadingMode = localStorage.getItem('readingMode');
            if (savedReadingMode !== null) {
                currentReadingMode = savedReadingMode;
            } else {
                currentReadingMode = 'scroll'; // Default to scroll mode
            }
            // applyReadingMode will be called within fetchWorkData to handle webtoon specific logic

            fetchWorkData(); // Fetch work data after Firebase is initialized
        });

        // Firebase Auth State Listener
        onAuthStateChanged(auth, (user) => {
            updateAuthSection(user);
        });

        // Auth button in header (for login/dropdown)
        authButtonHeader.addEventListener('click', (event) => {
            if (auth.currentUser) {
                event.stopPropagation(); // Prevent document click from immediately closing
                userDropdownMenuHeader.classList.toggle('hidden');
            } else {
                window.location.href = 'login.html'; // Redirect to login
            }
        });

        // Logout button in header dropdown
        logoutBtnHeader.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!userDropdownMenuHeader.contains(event.target) && !authButtonHeader.contains(event.target)) {
                userDropdownMenuHeader.classList.add('hidden');
            }
        });

        // Page navigation buttons in header
        prevPageHeaderBtn.addEventListener('click', goToPrevPage);
        nextPageHeaderBtn.addEventListener('click', goToNextPage);

        // Settings modal controls
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            // Set initial state of controls in modal
            darkModeToggle.checked = document.body.classList.contains('dark-mode');
            currentFontSizeDisplay.textContent = `${currentFontSize.toFixed(1)}rem`;
            if (currentReadingMode === 'scroll') {
                scrollModeRadio.checked = true;
            } else {
                bookModeRadio.checked = true;
            }
            // Disable book mode if it's a webtoon
            if (currentWorkData && currentWorkData.type === 'webtoon') {
                bookModeRadio.disabled = true;
                bookModeRadio.closest('label').style.opacity = '0.5'; // Visually indicate disabled
            } else {
                bookModeRadio.disabled = false;
                bookModeRadio.closest('label').style.opacity = '1';
            }
        });

        closeSettingsModal.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        darkModeToggle.addEventListener('change', (event) => {
            applyDarkModeToPage(event.target.checked);
        });

        modalFontDecreaseButton.addEventListener('click', () => adjustFontSize(-0.1));
        modalFontIncreaseButton.addEventListener('click', () => adjustFontSize(0.1));

        readingModeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                applyReadingMode(event.target.value);
            });
        });

        // Back to detail page button
        backToDetailBtn.addEventListener('click', () => {
            if (workId) {
                window.location.href = `/view/${workId}`; // Navigate back to the detail page
            } else {
                window.history.back(); // Fallback to browser history back
            }
        });

        // Like button in footer
        likeButton.addEventListener('click', handleLikeUnlike);

        // --- New: Swipe and Keyboard Navigation ---

        // Swipe event listeners on the document container
        documentPageContainer.addEventListener('touchstart', (e) => {
            if (currentReadingMode === 'book') {
                touchStartX = e.touches[0].clientX;
            }
        });

        documentPageContainer.addEventListener('touchmove', (e) => {
            if (currentReadingMode === 'book') {
                touchEndX = e.touches[0].clientX;
            }
        });

        documentPageContainer.addEventListener('touchend', () => {
            if (currentReadingMode === 'book') {
                const swipeDistance = touchStartX - touchEndX;
                if (swipeDistance > swipeThreshold) {
                    // Swiped left (go to next page)
                    goToNextPage();
                } else if (swipeDistance < -swipeThreshold) {
                    // Swiped right (go to previous page)
                    goToPrevPage();
                }
                // Reset touch variables
                touchStartX = 0;
                touchEndX = 0;
            }
        });

        // Keyboard event listener for arrow keys
        document.addEventListener('keydown', (e) => {
            if (currentReadingMode === 'book') {
                if (e.key === 'ArrowLeft') {
                    goToPrevPage();
                } else if (e.key === 'ArrowRight') {
                    goToNextPage();
                }
            }
        });

    </script>
</body>
</html>
