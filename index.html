<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFIQ - HTML Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Pretendard Web Font Definitions */
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-SemiBold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Bold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-ExtraBold.woff') format('woff');
            font-weight: 800;
            font-style: normal;
        }

        /* Base font application */
        body {
            font-family: 'Pretendard', sans-serif;
        }

        /* Tailwind CSS Scrollbar Hide Utility (Optional, but good for aesthetics) */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Custom style for dropdown arrow rotation */
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition-property: transform;
            transition-duration: 300ms;
            transition-timing-function: ease-in-out;
        }

        /* Dark mode styles for home page */
        body.dark-mode {
            background-color: #121212; /* Very dark gray/near black */
            color: #e0e0e0; /* Light gray text */
        }
        body.dark-mode header.bg-white { /* Header when scrolled in dark mode */
            background-color: #1e1e1e; /* Darker header */
            box-shadow: none; /* Remove shadow */
        }
        body.dark-mode header a.text-teal-500 { /* CRAFIQ logo when scrolled */
            color: #2dd4bf; /* Teal-400 in dark mode */
        }
        body.dark-mode header a.text-gray-700 { /* Nav links when scrolled */
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode header .hover\:text-teal-600:hover {
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode header button.text-gray-600 { /* Search icon when scrolled */
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode header button.hover\:text-teal-600:hover {
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode span.text-gray-700 { /* User nickname when scrolled */
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode svg.text-gray-700 { /* Dropdown arrow when scrolled */
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode button.border-teal-600 { /* Login/Signup button when scrolled */
            border-color: #2dd4bf; /* Teal-400 */
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode button.hover\:bg-teal-50:hover {
            background-color: #2a2a2a; /* Darker hover */
        }

        /* Main content sections in dark mode */
        body.dark-mode section.bg-white {
            background-color: #1e1e1e; /* Darker card background */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode h2.text-gray-900 {
            color: #e0e0e0; /* Light headings */
        }
        body.dark-mode p.text-gray-600 {
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode footer {
            background-color: #121212; /* Dark footer */
            color: #c0c0c0;
        }
        body.dark-mode footer .text-teal-400 {
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode footer .text-gray-600 {
            color: #888888; /* Gray-400 */
        }

        /* Hero section specific styles */
        #hero-section .hero-tags span {
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white for tags */
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            color: #ffffff; /* text-white */
        }

        #hero-section .hero-info span {
            font-size: 0.875rem; /* text-sm */
            color: #ffffff; /* text-white */
            opacity: 0.8; /* Slightly transparent */
        }
        #hero-section .hero-info svg {
            width: 1rem; /* w-4 */
            height: 1rem; /* h-4 */
            color: #ffffff; /* text-white */
            opacity: 0.8;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">

    <header id="main-header" class="fixed top-0 left-0 w-full z-50 py-3 transition-all duration-500 ease-in-out bg-transparent">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-extrabold transition-colors duration-500 text-white">
                CRAFIQ
            </a>

            <nav class="hidden md:flex space-x-6">
                <a href="about.html" class="text-sm font-semibold transition-colors duration-500 text-white hover:text-gray-300">
                    소개
                </a>
                <a href="#" class="text-sm font-semibold transition-colors duration-500 text-white hover:text-gray-300">
                    인기작품
                </a>
                <a href="author.html" class="text-sm font-semibold transition-colors duration-500 text-white hover:text-gray-300">
                    작가 페이지
                </a>
                <a href="#" class="text-sm font-semibold transition-colors duration-500 text-white hover:text-gray-300">
                    커뮤니티
                </a>
            </nav>

            <div class="flex items-center space-x-4">
                <button class="transition-colors duration-500 text-white hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                </button>
                <div id="auth-section" class="flex items-center space-x-4">
                    <button id="login-signup-btn" class="px-4 py-2 rounded-full text-sm font-semibold transition-all duration-500 text-white border border-white hover:bg-white hover:text-teal-600">
                        로그인/회원가입
                    </button>
                    <div id="user-info-display" class="relative hidden items-center space-x-1">
                        <span id="user-nickname" class="text-sm font-semibold text-white"></span>
                        <button id="dropdown-toggle-btn" class="cursor-pointer p-1 rounded-full hover:bg-white/10 transition-colors">
                            <svg id="dropdown-arrow-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="user-dropdown-menu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden z-20">
                            <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">내 프로필</a>
                            <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">설정</a>
                            <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                로그아웃
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section id="hero-section" class="relative w-full h-[600px] md:h-[800px] bg-cover bg-center flex items-center overflow-hidden transition-all duration-500 ease-in-out">
            <div class="absolute inset-0 bg-gradient-to-br from-[#2a2a4e] to-[#0a0a2a] opacity-90"></div>

            <button id="prev-banner-btn" class="absolute left-4 p-2 text-white bg-black bg-opacity-30 rounded-full hover:bg-opacity-50 transition-opacity z-10 md:block hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                    <path d="m15 18-6-6 6-6"></path>
                </svg>
            </button>

            <div id="banner-content" class="container mx-auto px-4 relative z-10 text-white text-left">
                <div id="hero-tags" class="flex space-x-2 mb-4 hero-tags">
                    </div>

                <h1 id="banner-title" class="text-4xl md:text-6xl font-extrabold leading-tight mb-2">
                    </h1>
                <p id="banner-description" class="text-lg md:text-xl font-medium mb-4"></p>

                <div id="hero-info" class="flex items-center space-x-4 mb-8 hero-info">
                    <span class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <span id="banner-views"></span>
                    </span>
                    <span class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                        </svg>
                        <span id="banner-likes"></span>
                    </span>
                    <span id="banner-author" class="text-sm font-semibold"></span>
                </div>

                <div class="flex space-x-4">
                    <button class="px-6 py-3 bg-white text-teal-600 font-bold rounded-md text-lg hover:bg-gray-100 transition-colors duration-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        지금 읽기
                    </button>
                    <button class="px-6 py-3 border border-white text-white font-bold rounded-md text-lg hover:bg-white hover:text-teal-600 transition-colors duration-300">
                        </button>
                </div>
            </div>

            <button id="next-banner-btn" class="absolute right-4 p-2 text-white bg-black bg-opacity-30 rounded-full hover:bg-opacity-50 transition-opacity z-10 md:block hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                    <path d="m9 18 6-6-6-6"></path>
                </svg>
            </button>

            <div id="pagination-dots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2 z-10">
                </div>
        </section>

        <section class="container mx-auto px-4 py-8 mt-8">
            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-900">크래픽 인기 작품</h2>
            <div class="flex space-x-4 mb-6 border-b border-gray-200">
                <button id="tab-실시간" class="pb-2 text-lg font-semibold text-teal-600 border-b-2 border-teal-600 transition-colors duration-200" data-tab="실시간">
                    실시간
                </button>
                <button id="tab-이번 주" class="pb-2 text-lg font-semibold text-gray-600 hover:text-teal-600 transition-colors duration-200" data-tab="이번 주">
                    이번 주
                </button>
                <button id="tab-분기" class="pb-2 text-lg font-semibold text-gray-600 hover:text-teal-600 transition-colors duration-200" data-tab="분기">
                    분기
                </button>
                <button id="tab-역대" class="pb-2 text-lg font-semibold text-gray-600 hover:text-teal-600 transition-colors duration-200" data-tab="역대">
                    역대
                </button>
            </div>

            <div id="popular-anime-container" class="flex overflow-x-scroll scrollbar-hide space-x-4 pb-4">
                </div>
        </section>

        <section class="container mx-auto px-4 py-8">
            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-900">최신 작품</h2>
            <div id="exclusive-works-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300 py-10 px-4 mt-12">
        <div class="container mx-auto text-center">
            <div class="mb-4">
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">이용약관</a>
                <span class="text-gray-600 text-sm">|</span>
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">개인정보처리방침</a>
                <span class="text-gray-600 text-sm">|</span>
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">문의하기</a>
            </div>
            <p class="text-xs">&copy; 2025 Crafiq. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (replace with your actual config or load from environment)
        const firebaseConfig = JSON.parse(`{"apiKey": "AIzaSyBJFAV4-QMggAW2K1YtpsXIZ5PQ8KJzo9k", "authDomain": "crafiq-a.firebaseapp.com", "projectId": "crafiq-a", "storageBucket": "crafiq-a.firebasestorage.app", "messagingSenderId": "176082460783", "appId": "1:176082460783:web:cd0b594cc803932eaa2d9a", "measurementId": "G-QB84Z9EMZW"}`);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use __app_id if available

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Dummy data for Hero Banners (kept for example, but can be fetched from DB too)
        const heroBanners = [
            {
                id: 1,
                tags: ['실시간 인기작', '소설', 'fantasy'],
                title: 'sdf',
                description: 'sdf',
                views: 14,
                likes: 1,
                author: 'by xx.niteowl@gmail.com',
                imageUrl: 'https://quick-tv.com/data/editor/2407/3732456066_1720032578.7054.png' // Placeholder matching the dark blue/purple gradient
            },
            {
                id: 2,
                tags: ['신작', '로맨스', '드라마'],
                title: '우리가 빛을 잃기 전에',
                description: '점점 멀어지는 마음 속에서도 서로를 잊지 않기 위한 마지막 기록.',
                views: 500,
                likes: 50,
                author: 'by 작가명 A',
                imageUrl: 'https://placehold.co/1200x800/3a3a5e/ffffff?text=Hero+Banner+2'
            },
            {
                id: 3,
                tags: ['추천', '판타지', '액션'],
                title: '서랍 속에 남겨진 말들',
                description: '가슴 깊이 묻어둔 기억들이 다시 피어나는 순간.',
                views: 1200,
                likes: 120,
                author: 'by 작가명 B',
                imageUrl: 'https://placehold.co/1200x800/4a4a6e/ffffff?text=Hero+Banner+3'
            }
        ];

        // Dummy data for "크래픽 인기 작품" section has been removed.
        // It will now be fetched from Firestore based on views.

        let currentBannerIndex = 0;
        let touchStartX = 0;
        let touchEndX = 0;
        let autoSlideInterval;

        // Get DOM elements
        const header = document.getElementById('main-header');
        const heroSection = document.getElementById('hero-section');
        const bannerTitleElement = document.getElementById('banner-title');
        const bannerDescriptionElement = document.getElementById('banner-description');
        const heroTagsContainer = document.getElementById('hero-tags');
        const bannerViews = document.getElementById('banner-views');
        const bannerLikes = document.getElementById('banner-likes');
        const bannerAuthor = document.getElementById('banner-author');

        const prevBannerBtn = document.getElementById('prev-banner-btn');
        const nextBannerBtn = document.getElementById('next-banner-btn');
        const paginationDotsContainer = document.getElementById('pagination-dots');
        const popularAnimeContainer = document.getElementById('popular-anime-container');
        const exclusiveWorksContainer = document.getElementById('exclusive-works-container'); // Now for Firestore data
        const tabButtons = document.querySelectorAll('.flex.space-x-4.mb-6 button');

        // Auth-related DOM elements
        const authSection = document.getElementById('auth-section');
        const loginSignupBtn = document.getElementById('login-signup-btn');
        const userInfoDisplay = document.getElementById('user-info-display');
        const userNicknameSpan = document.getElementById('user-nickname');
        const dropdownToggleBtn = document.getElementById('dropdown-toggle-btn');
        const dropdownArrowIcon = document.getElementById('dropdown-arrow-icon');
        const userDropdownMenu = document.getElementById('user-dropdown-menu');
        const logoutBtn = document.getElementById('logout-btn');

        /**
         * Renders the current banner content and updates styling.
         */
        function renderBanner() {
            const currentBanner = heroBanners[currentBannerIndex];
            heroSection.style.backgroundImage = `url("${currentBanner.imageUrl}")`;

            // Clear previous tags
            heroTagsContainer.innerHTML = '';
            // Add new tags
            currentBanner.tags.forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.textContent = tag;
                heroTagsContainer.appendChild(tagSpan);
            });

            bannerTitleElement.textContent = currentBanner.title;
            bannerDescriptionElement.textContent = currentBanner.description;
            bannerViews.textContent = currentBanner.views;
            bannerLikes.textContent = currentBanner.likes;
            bannerAuthor.textContent = currentBanner.author;

            updatePaginationDots();
        }

        /**
         * Updates the pagination dots to reflect the current banner.
         */
        function updatePaginationDots() {
            paginationDotsContainer.innerHTML = ''; // Clear existing dots
            heroBanners.forEach((_, index) => {
                const dot = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                dot.setAttribute('width', '24');
                dot.setAttribute('height', '24');
                dot.setAttribute('viewBox', '0 0 24 24');
                dot.setAttribute('fill', 'none');
                dot.setAttribute('stroke', 'currentColor');
                dot.setAttribute('stroke-width', '2');
                dot.setAttribute('stroke-linecap', 'round');
                dot.setAttribute('stroke-linejoin', 'round');
                dot.classList.add('w-2', 'h-2', 'text-white', 'cursor-pointer');
                dot.innerHTML = '<circle cx="12" cy="12" r="10"></circle>'; // Circle SVG path

                if (currentBannerIndex === index) {
                    dot.classList.add('fill-current', 'opacity-70');
                } else {
                    dot.classList.add('opacity-40');
                }
                dot.addEventListener('click', () => {
                    currentBannerIndex = index;
                    renderBanner();
                    resetAutoSlide();
                });
                paginationDotsContainer.appendChild(dot);
            });
        }

        /**
         * Navigates to the previous banner.
         */
        function handlePrevBanner() {
            currentBannerIndex = (currentBannerIndex === 0) ? heroBanners.length - 1 : currentBannerIndex - 1;
            renderBanner();
            resetAutoSlide();
        }

        /**
         * Navigates to the next banner.
         */
        function handleNextBanner() {
            currentBannerIndex = (currentBannerIndex === heroBanners.length - 1) ? 0 : currentBannerIndex + 1;
            renderBanner();
            resetAutoSlide();
        }

        /**
         * Resets the automatic banner slide interval.
         */
        function resetAutoSlide() {
            clearInterval(autoSlideInterval);
            autoSlideInterval = setInterval(handleNextBanner, 5000); // 5 seconds
        }

        /**
         * Handles scroll event to change header style.
         */
        function handleScroll() {
            const isScrolled = window.scrollY > 50;
            const isDarkMode = document.body.classList.contains('dark-mode');

            // Header background and shadow
            if (isScrolled) {
                if (isDarkMode) {
                    header.style.backgroundColor = '#1e1e1e'; /* Darker header for dark mode */
                    header.classList.remove('shadow-sm'); /* Remove shadow */
                    header.style.borderBottom = 'none'; /* No border */
                } else {
                    header.classList.add('bg-white');
                    header.classList.remove('shadow-sm'); /* Remove shadow */
                    header.style.backgroundColor = ''; // Reset to default white
                    header.style.borderBottom = 'none'; /* No border */
                }
            } else {
                header.classList.remove('bg-white');
                header.classList.remove('shadow-sm'); /* Remove shadow */
                header.style.backgroundColor = 'transparent'; // Transparent when not scrolled
                header.style.borderBottom = 'none'; /* No border when transparent */
            }

            // Update logo color
            const logo = header.querySelector('a.text-2xl');
            if (isScrolled) {
                logo.classList.remove('text-white');
                if (isDarkMode) {
                    logo.style.color = '#2dd4bf'; // Teal-400 for dark mode
                } else {
                    logo.classList.add('text-teal-500');
                    logo.style.color = ''; // Reset to default teal
                }
            } else {
                logo.classList.remove('text-teal-500');
                logo.classList.add('text-white');
                logo.style.color = ''; // Reset to default white
            }


            // Update nav links color
            header.querySelectorAll('nav a').forEach(link => {
                if (isScrolled) {
                    link.classList.remove('text-white', 'hover:text-gray-300');
                    if (isDarkMode) {
                        link.style.color = '#c0c0c0'; // Gray-300
                        link.style.setProperty('color', '#2dd4bf', 'important'); // Teal-400 for hover
                    } else {
                        link.classList.add('text-gray-700', 'hover:text-teal-600');
                        link.style.color = '';
                        link.style.setProperty('color', '', 'important');
                    }
                } else {
                    link.classList.remove('text-gray-700', 'hover:text-teal-600');
                    link.classList.add('text-white', 'hover:text-gray-300');
                    link.style.color = '';
                    link.style.setProperty('color', '', 'important');
                }
            });

            // Update search icon color
            const searchButton = document.querySelector('header .flex.items-center.space-x-4:last-child button');
            if (searchButton) {
                if (isScrolled) {
                    searchButton.classList.remove('text-white', 'hover:text-gray-300');
                    if (isDarkMode) {
                        searchButton.style.color = '#c0c0c0'; // Gray-300
                        searchButton.style.setProperty('color', '#2dd4bf', 'important'); // Teal-400 for hover
                    } else {
                        searchButton.classList.add('text-gray-600', 'hover:text-teal-600');
                        searchButton.style.color = '';
                        searchButton.style.setProperty('color', '', 'important');
                    }
                } else {
                    searchButton.classList.remove('text-gray-600', 'hover:text-teal-600');
                    searchButton.classList.add('text-white', 'hover:text-gray-300');
                    searchButton.style.color = '';
                    searchButton.style.setProperty('color', '', 'important');
                }
            }

            // Update user nickname color and dropdown icon color
            if (userNicknameSpan) {
                if (isScrolled) {
                    userNicknameSpan.classList.remove('text-white');
                    if (isDarkMode) {
                        userNicknameSpan.style.color = '#c0c0c0'; // Gray-300
                    } else {
                        userNicknameSpan.classList.add('text-gray-700');
                        userNicknameSpan.style.color = '';
                    }
                } else {
                    userNicknameSpan.classList.remove('text-gray-700');
                    userNicknameSpan.classList.add('text-white');
                    userNicknameSpan.style.color = '';
                }
            }
            if (dropdownArrowIcon) {
                if (isScrolled) {
                    dropdownArrowIcon.classList.remove('text-white');
                    if (isDarkMode) {
                        dropdownArrowIcon.style.color = '#c0c0c0'; // Gray-300
                    } else {
                        dropdownArrowIcon.classList.add('text-gray-700');
                        dropdownArrowIcon.style.color = '';
                    }
                } else {
                    dropdownArrowIcon.classList.remove('text-gray-700');
                    dropdownArrowIcon.classList.add('text-white');
                    dropdownArrowIcon.style.color = '';
                }
            }

            // Update login/signup button style if it's visible
            if (loginSignupBtn && !loginSignupBtn.classList.contains('hidden')) {
                if (isScrolled) {
                    loginSignupBtn.classList.remove('text-white', 'border-white', 'hover:bg-white', 'hover:text-teal-600');
                    if (isDarkMode) {
                        loginSignupBtn.style.color = '#2dd4bf'; // Teal-400
                        loginSignupBtn.style.borderColor = '#2dd4bf'; // Teal-400
                        loginSignupBtn.style.backgroundColor = ''; // Reset background
                        loginSignupBtn.classList.remove('hover:bg-teal-50');
                        loginSignupBtn.style.setProperty('background-color', '#2a2a2a', 'important'); // Darker hover
                        loginSignupBtn.style.setProperty('color', '#2dd4bf', 'important'); // Teal-400 on hover
                    } else {
                        loginSignupBtn.classList.add('text-teal-600', 'border-teal-600', 'hover:bg-teal-50');
                        loginSignupBtn.style.color = '';
                        loginSignupBtn.style.borderColor = '';
                        loginSignupBtn.style.backgroundColor = '';
                        loginSignupBtn.style.setProperty('background-color', '', 'important');
                        loginSignupBtn.style.setProperty('color', '', 'important');
                    }
                } else {
                    loginSignupBtn.classList.remove('text-teal-600', 'border-teal-600', 'hover:bg-teal-50');
                    loginSignupBtn.classList.add('text-white', 'border-white', 'hover:bg-white', 'hover:text-teal-600');
                    loginSignupBtn.style.color = '';
                    loginSignupBtn.style.borderColor = '';
                    loginSignupBtn.style.backgroundColor = '';
                    loginSignupBtn.style.setProperty('background-color', '', 'important');
                    loginSignupBtn.style.setProperty('color', '', 'important');
                }
            }
        }

        /**
         * Handles touch start event for swipe.
         * @param {TouchEvent} e - The touch event.
         */
        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
        }

        /**
         * Handles touch move event for swipe.
         * @param {TouchEvent} e - The touch event.
         */
        function handleTouchMove(e) {
            touchEndX = e.touches[0].clientX;
        }

        /**
         * Handles touch end event for swipe and determines swipe direction.
         */
        function handleTouchEnd() {
            const swipeDistance = touchStartX - touchEndX;
            const minSwipeDistance = 50; // Minimum distance for a recognized swipe

            if (swipeDistance > minSwipeDistance) {
                // Swiped left (next banner)
                handleNextBanner();
            } else if (swipeDistance < -minSwipeDistance) {
                // Swiped right (previous banner)
                handlePrevBanner();
            }
        }

        /**
         * Fetches and renders the popular works from Firestore based on views.
         */
        function fetchAndRenderPopularWorks() {
            const worksCollectionRef = collection(db, `artifacts/${appId}/public/data/works`);
            // Order by views in descending order to get the most popular works
            const q = query(worksCollectionRef, orderBy('views', 'desc'), limit(7)); // Limit to 7 popular works

            onSnapshot(q, (snapshot) => {
                popularAnimeContainer.innerHTML = ''; // Clear existing items
                if (snapshot.empty) {
                    popularAnimeContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">아직 인기 작품이 없습니다.</p>';
                    return;
                }

                let rank = 1;
                snapshot.forEach(doc => {
                    const work = doc.data();
                    const div = document.createElement('div');
                    // Increased width classes for carousel items and added rounded-md to images
                    div.className = 'flex-shrink-0 w-64 md:w-72 lg:w-80 cursor-pointer flex flex-col';
                    div.innerHTML = `
                        <div class="relative">
                            <img src="${work.thumbnailUrl || 'https://placehold.co/200x112/CCCCCC/333333?text=No+Thumbnail'}" alt="${work.title}" class="w-full h-auto object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/200x112/CCCCCC/333333?text=Image+Error';"/>
                        </div>
                        <div class="flex items-start pt-2">
                            <div class="text-5xl font-extrabold text-black mr-2">${rank}</div>
                            <div class="flex-1">
                                <h3 class="text-base md:text-lg font-bold text-gray-900 truncate mb-1">${work.title}</h3>
                                <p class="text-sm text-gray-600 line-clamp-2">${work.introduction || '소개 없음'}</p>
                            </div>
                        </div>
                    `;
                    popularAnimeContainer.appendChild(div);
                    rank++;
                });
            }, (error) => {
                console.error("Error fetching popular works:", error);
                popularAnimeContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">인기 작품을 불러오는 중 오류가 발생했습니다.</p>';
            });
        }


        /**
         * Fetches and renders the latest works from Firestore.
         */
        function fetchAndRenderLatestWorks() {
            const worksCollectionRef = collection(db, `artifacts/${appId}/public/data/works`);
            // Order by timestamp in descending order to get the latest works
            const q = query(worksCollectionRef, orderBy('timestamp', 'desc'), limit(10)); // Limit to 10 latest works

            onSnapshot(q, (snapshot) => {
                exclusiveWorksContainer.innerHTML = ''; // Clear existing items
                if (snapshot.empty) {
                    exclusiveWorksContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">아직 업로드된 작품이 없습니다.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const work = doc.data();
                    const workId = doc.id;
                    const div = document.createElement('div');
                    div.className = 'flex-shrink-0 w-full cursor-pointer bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200 hover:shadow-md transition-shadow duration-200';
                    div.innerHTML = `
                        <a href="upload.html?workId=${workId}" class="block">
                            <img src="${work.thumbnailUrl || 'https://placehold.co/400x225/CCCCCC/333333?text=No+Thumbnail'}" alt="${work.title}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x225/CCCCCC/333333?text=No+Thumbnail';"/>
                            <div class="p-4">
                                <h3 class="text-lg font-bold text-gray-900 truncate mb-1">${work.title}</h3>
                                <p class="text-sm text-gray-600 line-clamp-2 mb-2">${work.introduction || '소개 없음'}</p>
                                <div class="flex items-center text-xs text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    <span>${work.views || 0}</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                                    </svg>
                                    <span>${work.likes || 0}</span>
                                    <span class="ml-auto">by ${work.authorNickname || '알 수 없음'}</span>
                                </div>
                            </div>
                        </a>
                    `;
                    exclusiveWorksContainer.appendChild(div);
                });
            }, (error) => {
                console.error("Error fetching latest works:", error);
                exclusiveWorksContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">작품을 불러오는 중 오류가 발생했습니다.</p>';
            });
        }


        /**
         * Handles tab clicks for popular works section.
         * @param {Event} event - The click event.
         */
        function handleTabClick(event) {
            tabButtons.forEach(button => {
                button.classList.remove('text-teal-600', 'border-b-2', 'border-teal-600');
                button.classList.add('text-gray-600', 'hover:text-teal-600');
            });
            event.target.classList.add('text-teal-600', 'border-b-2', 'border-teal-600');
            event.target.classList.remove('text-gray-600', 'hover:text-teal-600');

            const selectedTab = event.target.dataset.tab;
            if (selectedTab === '실시간') {
                fetchAndRenderPopularWorks();
            } else {
                // For other tabs, you might fetch different data or display a message
                popularAnimeContainer.innerHTML = `<p class="text-gray-500 text-center w-full">"${selectedTab}" 탭은 아직 구현되지 않았습니다.</p>`;
                console.log(`Tab "${selectedTab}" clicked. Functionality not implemented.`);
            }
        }

        /**
         * Updates the header's authentication section based on user login status.
         * @param {Object|null} user - The Firebase User object or null if logged out.
         */
        async function updateAuthSection(user) {
            if (user) {
                // User is logged in
                loginSignupBtn.classList.add('hidden'); // 로그인/회원가입 버튼 숨김
                authSection.classList.remove('hidden'); // Ensure auth-section is visible
                userInfoDisplay.classList.remove('hidden'); // Show user info display
                userInfoDisplay.classList.add('flex'); // 레이아웃을 위해 flex로 설정

                // 닉네임을 가져오는 동안 "로딩 중..." 메시지 표시
                userNicknameSpan.textContent = '로딩 중...';

                // Firestore에서 사용자 닉네임 가져오기
                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/userProfiles`, user.uid);
                try {
                    const docSnap = await getDoc(userProfileRef);
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        // 닉네임이 존재하고 비어있지 않으면 닉네임 표시
                        if (userData.nickname && userData.nickname.trim() !== '') {
                            userNicknameSpan.textContent = userData.nickname;
                        } else {
                            // 닉네임이 없거나 비어있으면 이메일 표시 (또는 "사용자")
                            userNicknameSpan.textContent = user.email || '사용자';
                            console.warn("User profile found but nickname is empty or missing, displaying email:", user.uid);
                        }
                    } else {
                        // 사용자 프로필 문서가 없으면 이메일 표시 (또는 "사용자")
                        userNicknameSpan.textContent = user.email || '사용자';
                        console.warn("User profile document not found for:", user.uid);
                    }
                } catch (error) {
                    console.error("Error fetching user profile, displaying email:", error);
                    // 오류 발생 시 이메일 표시 (또는 "오류")
                    userNicknameSpan.textContent = user.email || '오류';
                }
            } else {
                // User is logged out
                loginSignupBtn.classList.remove('hidden'); // 로그인/회원가입 버튼 표시
                userInfoDisplay.classList.add('hidden'); // 사용자 정보 표시 숨김
                userInfoDisplay.classList.remove('flex');
                userNicknameSpan.textContent = ''; // 닉네임 지우기
                userDropdownMenu.classList.add('hidden'); // 드롭다운 메뉴 숨김
                if (dropdownArrowIcon) {
                    dropdownArrowIcon.classList.remove('rotate-180'); // 화살표 아이콘 회전 초기화
                }
            }
            // 가시성 업데이트 후 스크롤 기반 스타일 다시 적용
            handleScroll();
        }

        /**
         * Applies or removes dark mode based on the toggle state.
         * This function is called on page load and when the dark mode toggle is changed.
         */
        function applyDarkModeToPage(isDarkMode) {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            // Re-apply scroll-based header styles after dark mode change
            handleScroll();
        }


        // Firebase 인증 상태 리스너
        onAuthStateChanged(auth, (user) => {
            updateAuthSection(user);
        });

        // 로그인/회원가입 버튼 클릭 핸들러
        loginSignupBtn.addEventListener('click', () => {
            window.location.href = 'login.html'; // 로그인 페이지로 리디렉션
        });

        // 드롭다운 토글 버튼 클릭 핸들러
        dropdownToggleBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            userDropdownMenu.classList.toggle('hidden');
            if (dropdownArrowIcon) {
                dropdownArrowIcon.classList.toggle('rotate-180');
            }
        });

        // 로그아웃 버튼 클릭 핸들러 (드롭다운 내부)
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
                // onAuthStateChanged 리스너에 의해 updateAuthSection이 호출될 것임
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });

        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', (event) => {
            if (!userDropdownMenu.contains(event.target) && !dropdownToggleBtn.contains(event.target)) {
                userDropdownMenu.classList.add('hidden');
                if (dropdownArrowIcon) {
                    dropdownArrowIcon.classList.remove('rotate-180');
                }
            }
        });


        // 이벤트 리스너
        window.addEventListener('load', () => {
            // Check for dark mode preference on page load
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                applyDarkModeToPage(savedDarkMode === 'true');
            }

            renderBanner(); // 배너 초기 렌더링
            resetAutoSlide(); // 자동 슬라이드 시작
            fetchAndRenderPopularWorks(); // 인기 작품 섹션 렌더링 (Firestore에서 조회수 기반으로 가져옴)
            fetchAndRenderLatestWorks(); // 최신 작품 섹션 렌더링 (Firestore에서 가져옴)
            // 초기 위치에 따라 헤더 스타일을 설정하기 위한 handleScroll 초기 호출
            handleScroll();
        });

        window.addEventListener('scroll', handleScroll);
        prevBannerBtn.addEventListener('click', handlePrevBanner);
        nextBannerBtn.addEventListener('click', handleNextBanner);

        heroSection.addEventListener('touchstart', handleTouchStart);
        heroSection.addEventListener('touchmove', handleTouchMove);
        heroSection.addEventListener('touchend', handleTouchEnd);

        tabButtons.forEach(button => {
            button.addEventListener('click', handleTabClick);
        });

    </script>
</body>
</html>
