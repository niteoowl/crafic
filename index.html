<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFIQ - HTML Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Pretendard Web Font Definitions */
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-SemiBold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Bold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-ExtraBold.woff') format('woff');
            font-weight: 800;
            font-style: normal;
        }

        /* Base font application */
        body {
            font-family: 'Pretendard', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Tailwind CSS Scrollbar Hide Utility (Optional, but good for aesthetics) */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Custom style for dropdown arrow rotation */
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition-property: transform;
            transition-duration: 300ms;
            transition-timing-function: ease-in-out;
        }

        /* Dark mode styles for home page */
        body.dark-mode {
            background-color: #121212; /* Very dark gray/near black */
            color: #e0e0e0; /* Light gray text */
        }
        body.dark-mode header.bg-white { /* Header when scrolled in dark mode */
            background-color: #1e1e1e; /* Darker header */
            box-shadow: none; /* Remove shadow */
        }
        body.dark-mode header a.text-teal-500 { /* CRAFIQ logo when scrolled */
            color: #2dd4bf; /* Teal-400 in dark mode */
        }
        body.dark-mode header a.text-gray-700 { /* Nav links when scrolled */
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode header .hover\:text-teal-600:hover {
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode header button.text-gray-600 { /* Search icon when scrolled */
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode header button.hover\:text-teal-600:hover {
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode span.text-gray-700 { /* User nickname when scrolled */
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode svg.text-gray-700 { /* Dropdown arrow when scrolled */
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode button.border-teal-600 { /* Login/Signup button when scrolled */
            border-color: #2dd4bf; /* Teal-400 */
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode button.hover\:bg-teal-50:hover {
            background-color: #2a2a2a; /* Darker hover */
        }

        /* Main content sections in dark mode */
        body.dark-mode section.bg-white {
            background-color: #1e1e1e; /* Darker card background */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode h2.text-gray-900 {
            color: #e0e0e0; /* Light headings */
        }
        body.dark-mode p.text-gray-600 {
            color: #c0c0c0; /* Gray-300 */
        }
        body.dark-mode footer {
            background-color: #121212; /* Dark footer */
            color: #c0c0c0;
        }
        body.dark-mode footer .text-teal-400 {
            color: #2dd4bf; /* Teal-400 */
        }
        body.dark-mode footer .text-gray-600 {
            color: #888888; /* Gray-400 */
        }

        /* Hero section specific styles */
        #hero-section .hero-tags span {
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white for tags */
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            color: #ffffff; /* text-white */
        }

        #hero-section .hero-info span {
            font-size: 0.875rem; /* text-sm */
            color: #ffffff; /* text-white */
            opacity: 0.8; /* Slightly transparent */
        }
        #hero-section .hero-info svg {
            width: 1rem; /* w-4 */
            height: 1rem; /* h-4 */
            color: #ffffff; /* text-white */
            opacity: 0.8;
        }

        /* Work card styles - adjusted for horizontal scroll layout */
        .work-card {
            flex-shrink: 0; /* Prevent shrinking in flex container */
            width: 200px; /* Fixed width for consistent display in carousel */
            cursor: pointer;
            border-radius: 0.5rem; /* rounded-md */
            overflow: hidden; /* Ensures image corners are rounded */
            background-color: #fff; /* Default background for cards */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Subtle shadow */
            padding: 0.75rem; /* p-3 for padding inside card */
        }
        body.dark-mode .work-card {
            background-color: #1e1e1e; /* Darker card background */
            box-shadow: none; /* Remove shadow in dark mode */
        }
        .work-card img {
            width: 100%;
            height: 112px; /* Fixed height for consistent image size */
            object-fit: cover;
            border-radius: 0.375rem; /* rounded-md */
        }
        .work-card .rank { /* This class is applied to the rank number itself */
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
            color: #333; /* Default dark color */
        }
        body.dark-mode .work-card .rank {
            color: #e0e0e0; /* Light color in dark mode */
        }
        .work-card h3 {
            font-size: 1rem; /* text-base */
            font-weight: 700; /* font-bold */
            color: #333; /* Default dark color */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        body.dark-mode .work-card h3 {
            color: #e0e0e0; /* Light color in dark mode */
        }
        .work-card p {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* Default gray */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        body.dark-mode .work-card p {
            color: #c0c0c0; /* Light gray in dark mode */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">

    <header id="main-header" class="fixed top-0 left-0 w-full z-50 py-3 transition-all duration-500 ease-in-out bg-transparent">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-extrabold transition-colors duration-500 text-white">
                CRAFIQ
            </a>

            <nav class="hidden md:flex space-x-6">
                <a href="about.html" class="text-sm font-semibold transition-colors duration-500 text-white hover:text-gray-300">
                    소개
                </a>
                <a href="#" class="text-sm font-semibold transition-colors duration-500 text-white hover:text-gray-300">
                    인기작품
                </a>
                <a href="author.html" class="text-sm font-semibold transition-colors duration-500 text-white hover:text-gray-300">
                    작가 페이지
                </a>
                <a href="#" class="text-sm font-semibold transition-colors duration-500 text-white hover:text-gray-300">
                    커뮤니티
                </a>
            </nav>

            <div class="flex items-center space-x-4">
                <button class="transition-colors duration-500 text-white hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                </button>
                <div id="auth-section" class="flex items-center space-x-4">
                    <button id="login-signup-btn" class="px-4 py-2 rounded-full text-sm font-semibold transition-all duration-500 text-white border border-white hover:bg-white hover:text-teal-600">
                        로그인/회원가입
                    </button>
                    <div id="user-info-display" class="relative hidden items-center space-x-1">
                        <span id="user-nickname" class="text-sm font-semibold text-white"></span>
                        <button id="dropdown-toggle-btn" class="cursor-pointer p-1 rounded-full hover:bg-white/10 transition-colors">
                            <svg id="dropdown-arrow-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="user-dropdown-menu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden z-20">
                            <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">내 프로필</a>
                            <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">설정</a>
                            <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                로그아웃
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section id="hero-section" class="relative w-full h-[600px] md:h-[800px] bg-cover bg-center flex items-center overflow-hidden transition-all duration-500 ease-in-out">
            <div class="absolute inset-0 bg-gradient-to-br from-[#2a2a4e] to-[#0a0a2a] opacity-90"></div>

            <button id="prev-banner-btn" class="absolute left-4 p-2 text-white bg-black bg-opacity-30 rounded-full hover:bg-opacity-50 transition-opacity z-10 md:block hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                    <path d="m15 18-6-6 6-6"></path>
                </svg>
            </button>

            <div id="banner-content" class="container mx-auto px-4 relative z-10 text-white text-left">
                <div id="hero-tags" class="flex space-x-2 mb-4 hero-tags">
                    </div>

                <h1 id="banner-title" class="text-4xl md:text-6xl font-extrabold leading-tight mb-2">
                    </h1>
                <p id="banner-description" class="text-lg md:text-xl font-medium mb-4"></p>

                <div id="hero-info" class="flex items-center space-x-4 mb-8 hero-info">
                    <span class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <span id="banner-views"></span>
                    </span>
                    <span class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                        </svg>
                        <span id="banner-likes"></span>
                    </span>
                    <span id="banner-author" class="text-sm font-semibold"></span>
                </div>

                <div class="flex space-x-4">
                    <button class="px-6 py-3 bg-white text-teal-600 font-bold rounded-md text-lg hover:bg-gray-100 transition-colors duration-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        지금 읽기
                    </button>
                    <button class="px-6 py-3 border border-white text-white font-bold rounded-md text-lg hover:bg-white hover:text-teal-600 transition-colors duration-300">
                        상세 보기
                    </button>
                </div>
            </div>

            <button id="next-banner-btn" class="absolute right-4 p-2 text-white bg-black bg-opacity-30 rounded-full hover:bg-opacity-50 transition-opacity z-10 md:block hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                    <path d="m9 18 6-6-6-6"></path>
                </svg>
            </button>

            <div id="pagination-dots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2 z-10">
                </div>
            <div id="no-works-hero" class="absolute inset-0 flex flex-col items-center justify-center text-white text-center p-4 z-20 hidden">
                <h2 class="text-3xl md:text-5xl font-extrabold mb-4">CRAFIQ에 오신 것을 환영합니다!</h2>
                <p class="text-lg md:text-xl font-medium mb-6">아직 작품이 업로드되지 않았습니다. 첫 작품을 시작해 보세요!</p>
                <a href="upload-work.html" class="px-6 py-3 bg-teal-600 text-white font-bold rounded-md text-lg hover:bg-teal-700 transition-colors duration-300">
                    작품 업로드하기
                </a>
            </div>
        </section>

        <section class="container mx-auto px-4 py-8 mt-8">
            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-900">크래픽 인기 작품</h2>
            <div class="flex space-x-4 mb-6 border-b border-gray-200">
                <button id="tab-실시간" class="pb-2 text-lg font-semibold text-teal-600 border-b-2 border-teal-600 transition-colors duration-200" data-tab="실시간">
                    실시간
                </button>
                <button id="tab-이번 주" class="pb-2 text-lg font-semibold text-gray-600 hover:text-teal-600 transition-colors duration-200" data-tab="이번 주">
                    이번 주
                </button>
                <button id="tab-분기" class="pb-2 text-lg font-semibold text-gray-600 hover:text-teal-600 transition-colors duration-200" data-tab="분기">
                    분기
                </button>
                <button id="tab-역대" class="pb-2 text-lg font-semibold text-gray-600 hover:text-teal-600 transition-colors duration-200" data-tab="역대">
                    역대
                </button>
            </div>

            <div id="popular-anime-container" class="flex overflow-x-scroll scrollbar-hide space-x-4 pb-4">
                <p class="text-gray-500">인기 작품을 로딩 중입니다...</p>
            </div>
        </section>

        <section class="container mx-auto px-4 py-8">
            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-900">최신 작품</h2>
            <div id="exclusive-works-container" class="flex overflow-x-scroll scrollbar-hide space-x-4 pb-4">
                <p class="text-gray-500">최신 작품을 로딩 중입니다...</p>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300 py-10 px-4 mt-12">
        <div class="container mx-auto text-center">
            <div class="mb-4">
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">이용약관</a>
                <span class="text-gray-600 text-sm">|</span>
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">개인정보처리방침</a>
                <span class="text-gray-600 text-sm">|</span>
                <a href="#" class="text-teal-400 hover:text-teal-300 mx-3 text-sm">문의하기</a>
            </div>
            <p class="text-xs">&copy; 2025 Crafiq. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (replace with your actual config or load from environment)
        const firebaseConfig = JSON.parse(`{"apiKey": "AIzaSyBJFAV4-QMggAW2K1YtpsXIZ5PQ8KJzo9k", "authDomain": "crafiq-a.firebaseapp.com", "projectId": "crafiq-a", "storageBucket": "crafiq-a.firebasestorage.app", "messagingSenderId": "176082460783", "appId": "1:176082460783:web:cd0b594cc803932eaa2d9a", "measurementId": "G-QB84Z9EMZW"}`);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use __app_id if available
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get DOM elements
        const header = document.getElementById('main-header');
        const heroSection = document.getElementById('hero-section');
        const bannerContent = document.getElementById('banner-content'); // Renamed from heroContent
        const noWorksHero = document.getElementById('no-works-hero');
        const bannerTitleElement = document.getElementById('banner-title');
        const bannerDescriptionElement = document.getElementById('banner-description');
        const heroTagsContainer = document.getElementById('hero-tags');
        const bannerViews = document.getElementById('banner-views');
        const bannerLikes = document.getElementById('banner-likes');
        const bannerAuthor = document.getElementById('banner-author');

        const prevBannerBtn = document.getElementById('prev-banner-btn');
        const nextBannerBtn = document.getElementById('next-banner-btn');
        const paginationDotsContainer = document.getElementById('pagination-dots');
        // Updated IDs for popular and latest works containers
        const popularWorksContainer = document.getElementById('popular-anime-container'); // Changed ID
        const latestWorksContainer = document.getElementById('exclusive-works-container'); // Changed ID
        // Updated tab button selectors to match new IDs
        const tabButtons = document.querySelectorAll('.flex.space-x-4.mb-6.border-b.border-gray-200 button[data-tab]');

        let allWorks = []; // To store all fetched works
        let currentBannerIndex = 0; // Index for the hero banner carousel
        let autoSlideInterval;
        let touchStartX = 0;
        let touchEndX = 0;

        /**
         * Renders the hero section with a specific work or a default message.
         * @param {Object|null} work - The work object to display, or null for default.
         * @param {boolean} isInitialLoad - True if this is the initial load, to prevent immediate auto-slide reset.
         */
        function renderHeroSection(work, isInitialLoad = false) {
            if (work) {
                bannerContent.classList.remove('hidden');
                noWorksHero.classList.add('hidden');
                heroSection.style.backgroundImage = `url("${work.thumbnailUrl || 'https://placehold.co/1200x800/2a2a4e/ffffff?text=CRAFIQ'}")`;

                heroTagsContainer.innerHTML = '';
                if (work.tags && work.tags.length > 0) {
                    work.tags.forEach(tag => {
                        const tagSpan = document.createElement('span');
                        tagSpan.textContent = tag;
                        heroTagsContainer.appendChild(tagSpan);
                    });
                } else {
                    const defaultTag = document.createElement('span');
                    defaultTag.textContent = work.type === 'novel' ? '소설' : '웹툰';
                    heroTagsContainer.appendChild(defaultTag);
                }

                bannerTitleElement.textContent = work.title || '제목 없음';
                bannerDescriptionElement.textContent = work.introduction || '설명 없음';
                bannerViews.textContent = work.views !== undefined ? work.views.toLocaleString() : '0';
                bannerLikes.textContent = work.likes !== undefined ? work.likes.toLocaleString() : '0';
                bannerAuthor.textContent = work.authorNickname ? `by ${work.authorNickname}` : 'by 익명';

                // Show navigation buttons and dots only if there's more than one work
                if (allWorks.length > 1) {
                    prevBannerBtn.classList.remove('hidden');
                    nextBannerBtn.classList.remove('hidden');
                    paginationDotsContainer.classList.remove('hidden');
                } else {
                    prevBannerBtn.classList.add('hidden');
                    nextBannerBtn.classList.add('hidden');
                    paginationDotsContainer.classList.add('hidden');
                }

                updatePaginationDots();
                if (!isInitialLoad) {
                    resetAutoSlide();
                }
            } else {
                // No works uploaded
                bannerContent.classList.add('hidden');
                noWorksHero.classList.remove('hidden');
                heroSection.style.backgroundImage = `url('https://placehold.co/1200x800/2a2a4e/ffffff?text=CRAFIQ')`; // Default background
                prevBannerBtn.classList.add('hidden');
                nextBannerBtn.classList.add('hidden');
                paginationDotsContainer.classList.add('hidden');
                clearInterval(autoSlideInterval); // Stop auto-slide if no works
            }
        }

        /**
         * Updates the pagination dots to reflect the current banner.
         */
        function updatePaginationDots() {
            paginationDotsContainer.innerHTML = ''; // Clear existing dots
            allWorks.forEach((_, index) => {
                const dot = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                dot.setAttribute('width', '24');
                dot.setAttribute('height', '24');
                dot.setAttribute('viewBox', '0 0 24 24');
                dot.setAttribute('fill', 'none');
                dot.setAttribute('stroke', 'currentColor');
                dot.setAttribute('stroke-width', '2');
                dot.setAttribute('stroke-linecap', 'round');
                dot.setAttribute('stroke-linejoin', 'round');
                dot.classList.add('w-2', 'h-2', 'text-white', 'cursor-pointer');
                dot.innerHTML = '<circle cx="12" cy="12" r="10"></circle>'; // Circle SVG path

                if (currentBannerIndex === index) {
                    dot.classList.add('fill-current', 'opacity-70');
                } else {
                    dot.classList.add('opacity-40');
                }
                dot.addEventListener('click', () => {
                    currentBannerIndex = index;
                    renderHeroSection(allWorks[currentBannerIndex]);
                });
                paginationDotsContainer.appendChild(dot);
            });
        }

        /**
         * Navigates to the previous banner.
         */
        function handlePrevBanner() {
            currentBannerIndex = (currentBannerIndex === 0) ? allWorks.length - 1 : currentBannerIndex - 1;
            renderHeroSection(allWorks[currentBannerIndex]);
        }

        /**
         * Navigates to the next banner.
         */
        function handleNextBanner() {
            currentBannerIndex = (currentBannerIndex === allWorks.length - 1) ? 0 : currentBannerIndex + 1;
            renderHeroSection(allWorks[currentBannerIndex]);
        }

        /**
         * Resets the automatic banner slide interval.
         */
        function resetAutoSlide() {
            clearInterval(autoSlideInterval);
            if (allWorks.length > 1) { // Only auto-slide if there's more than one banner
                autoSlideInterval = setInterval(handleNextBanner, 5000); // 5 seconds
            }
        }

        /**
         * Handles touch start event for swipe.
         * @param {TouchEvent} e - The touch event.
         */
        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
        }

        /**
         * Handles touch move event for swipe.
         * @param {TouchEvent} e - The touch event.
         */
        function handleTouchMove(e) {
            touchEndX = e.touches[0].clientX;
        }

        /**
         * Handles touch end event for swipe and determines swipe direction.
         */
        function handleTouchEnd() {
            const swipeDistance = touchStartX - touchEndX;
            const minSwipeDistance = 50; // Minimum distance for a recognized swipe

            if (swipeDistance > minSwipeDistance) {
                // Swiped left (next banner)
                handleNextBanner();
            } else if (swipeDistance < -minSwipeDistance) {
                // Swiped right (previous banner)
                handlePrevBanner();
            }
        }

        /**
         * Renders a list of works into a container.
         * @param {HTMLElement} container - The DOM element to render works into.
         * @param {Array<Object>} works - An array of work objects.
         * @param {string} sectionType - 'popular' or 'latest' to adjust card style.
         */
        function renderWorkCards(container, works, sectionType) {
            container.innerHTML = ''; // Clear existing items
            if (works.length === 0) {
                container.innerHTML = `<p class="text-gray-500 dark:text-gray-400">아직 ${sectionType === 'popular' ? '인기' : '최신'} 작품이 없습니다.</p>`;
                return;
            }

            works.forEach((item, index) => {
                // This is the inner content of the card (image, title, description)
                const cardContentHtml = `
                    <div class="relative mb-2">
                        <img src="${item.thumbnailUrl || 'https://placehold.co/200x112/CCCCCC/333333?text=No+Image'}" alt="${item.title}" class="w-full h-auto object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/200x112/CCCCCC/333333?text=Image+Error';"/>
                    </div>
                    <div>
                        <h3 class="text-base md:text-lg font-bold text-gray-900 dark:text-e0e0e0 mb-1">${item.title}</h3>
                        <p class="text-sm text-gray-600 dark:text-c0c0c0 line-clamp-2">${item.introduction || '설명 없음'}</p>
                    </div>
                `;

                const workItemWrapper = document.createElement('div'); // This will be the wrapper for each work item, including rank if popular

                if (sectionType === 'popular') {
                    // For popular works, we need the rank number next to the card
                    workItemWrapper.className = 'flex flex-row items-start space-x-2'; // Use flex-row to align rank and card
                    workItemWrapper.innerHTML = `
                        <div class="rank text-4xl font-extrabold text-gray-900 dark:text-e0e0e0 pt-1">${index + 1}</div>
                        <div class="work-card"> ${cardContentHtml}
                        </div>
                    `;
                } else { // latest works (no rank number, just the card)
                    workItemWrapper.className = 'work-card'; // This div is the work-card itself
                    workItemWrapper.innerHTML = cardContentHtml;
                }
                container.appendChild(workItemWrapper);
            });
        }

        /**
         * Fetches and renders all works from Firestore.
         */
        function fetchAndRenderAllWorks() {
            const worksCollectionRef = collection(db, `artifacts/${appId}/public/data/works`);

            // Listen for changes in all public works to update the hero banner and latest works
            const allWorksQuery = query(worksCollectionRef, orderBy('timestamp', 'desc')); // Order by timestamp for consistent hero selection
            onSnapshot(allWorksQuery, (snapshot) => {
                allWorks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched all works:", allWorks);

                // Update hero banner
                if (allWorks.length > 0) {
                    // Ensure currentBannerIndex is within bounds if works are removed
                    if (currentBannerIndex >= allWorks.length) {
                        currentBannerIndex = 0;
                    }
                    renderHeroSection(allWorks[currentBannerIndex]);
                } else {
                    renderHeroSection(null); // Show default message if no works
                }

                // Render latest works (top 10 by timestamp)
                const latestWorks = allWorks.slice(0, 10);
                renderWorkCards(latestWorksContainer, latestWorks, 'latest');
            }, (error) => {
                console.error("Error fetching all works:", error);
                latestWorksContainer.innerHTML = '<p class="text-red-500">작품을 불러오는 데 실패했습니다.</p>';
                renderHeroSection(null); // Show default message on error
            });


            // Listen for popular works (initially by views)
            let currentPopularSortField = 'views'; // Default sort for popular section
            const renderPopularBySort = (sortField) => {
                const popularWorksQuery = query(worksCollectionRef, orderBy(sortField, 'desc'), limit(10));
                onSnapshot(popularWorksQuery, (snapshot) => {
                    const popularWorks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`Fetched popular works by ${sortField}:`, popularWorks);
                    renderWorkCards(popularWorksContainer, popularWorks, 'popular');
                }, (error) => {
                    console.error(`Error fetching popular works by ${sortField}:`, error);
                    popularWorksContainer.innerHTML = '<p class="text-red-500">인기 작품을 불러오는 데 실패했습니다.</p>';
                });
            };

            // Initial render for popular works
            renderPopularBySort(currentPopularSortField);

            // Add event listeners for popular works tabs
            tabButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    // Remove active state from all tabs
                    tabButtons.forEach(btn => {
                        btn.classList.remove('text-teal-600', 'border-b-2', 'border-teal-600');
                        btn.classList.add('text-gray-600', 'hover:text-teal-600');
                    });
                    // Add active state to clicked tab
                    event.target.classList.add('text-teal-600', 'border-b-2', 'border-teal-600');
                    event.target.classList.remove('text-gray-600', 'hover:text-teal-600');

                    // Determine sort field based on the data-tab attribute
                    let firestoreSortField = 'views'; // Default to views
                    switch (event.target.dataset.tab) {
                        case '실시간':
                        case '이번 주':
                            firestoreSortField = 'views'; // Map to views
                            break;
                        case '분기':
                        case '역대':
                            firestoreSortField = 'likes'; // Map to likes
                            break;
                        default:
                            firestoreSortField = 'views'; // Fallback
                    }
                    // Re-fetch and render popular works based on the selected tab
                    renderPopularBySort(firestoreSortField);
                });
            });
        }


        /**
         * Handles scroll event to change header style.
         */
        function handleScroll() {
            const isScrolled = window.scrollY > 50;
            const isDarkMode = document.body.classList.contains('dark-mode');

            // Header background and shadow
            if (isScrolled) {
                if (isDarkMode) {
                    header.style.backgroundColor = '#1e1e1e'; /* Darker header for dark mode */
                    header.classList.remove('shadow-sm'); /* Remove shadow */
                    header.style.borderBottom = 'none'; /* No border */
                } else {
                    header.classList.add('bg-white', 'shadow-sm'); /* Add shadow back */
                    header.style.backgroundColor = ''; // Reset to default white
                    header.style.borderBottom = 'none'; /* No border */
                }
            } else {
                header.classList.remove('bg-white', 'shadow-sm'); /* Remove shadow */
                header.style.backgroundColor = 'transparent'; // Transparent when not scrolled
                header.style.borderBottom = 'none'; /* No border when transparent */
            }

            // Update logo color
            const logo = header.querySelector('a.text-2xl');
            if (isScrolled) {
                logo.classList.remove('text-white');
                if (isDarkMode) {
                    logo.style.color = '#2dd4bf'; // Teal-400 for dark mode
                } else {
                    logo.classList.add('text-teal-500');
                    logo.style.color = ''; // Reset to default teal
                }
            } else {
                logo.classList.remove('text-teal-500');
                logo.classList.add('text-white');
                logo.style.color = ''; // Reset to default white
            }


            // Update nav links color
            header.querySelectorAll('nav a').forEach(link => {
                if (isScrolled) {
                    link.classList.remove('text-white', 'hover:text-gray-300');
                    if (isDarkMode) {
                        link.style.color = '#c0c0c0'; // Gray-300
                        // No specific hover color needed here, Tailwind's hover:text-teal-600 will apply
                    } else {
                        link.classList.add('text-gray-700', 'hover:text-teal-600');
                        link.style.color = '';
                    }
                } else {
                    link.classList.remove('text-gray-700', 'hover:text-teal-600');
                    link.classList.add('text-white', 'hover:text-gray-300');
                    link.style.color = '';
                }
            });

            // Update search icon color
            const searchButton = document.querySelector('header .flex.items-center.space-x-4:last-child button');
            if (searchButton) {
                if (isScrolled) {
                    searchButton.classList.remove('text-white', 'hover:text-gray-300');
                    if (isDarkMode) {
                        searchButton.style.color = '#c0c0c0'; // Gray-300
                    } else {
                        searchButton.classList.add('text-gray-600', 'hover:text-teal-600');
                        searchButton.style.color = '';
                    }
                } else {
                    searchButton.classList.remove('text-gray-600', 'hover:text-teal-600');
                    searchButton.classList.add('text-white', 'hover:text-gray-300');
                    searchButton.style.color = '';
                }
            }

            // Update user nickname color and dropdown icon color
            if (userNicknameSpan) {
                if (isScrolled) {
                    userNicknameSpan.classList.remove('text-white');
                    if (isDarkMode) {
                        userNicknameSpan.style.color = '#c0c0c0'; // Gray-300
                    } else {
                        userNicknameSpan.classList.add('text-gray-700');
                        userNicknameSpan.style.color = '';
                    }
                } else {
                    userNicknameSpan.classList.remove('text-gray-700');
                    userNicknameSpan.classList.add('text-white');
                    userNicknameSpan.style.color = '';
                }
            }
            if (dropdownArrowIcon) {
                if (isScrolled) {
                    dropdownArrowIcon.classList.remove('text-white');
                    if (isDarkMode) {
                        dropdownArrowIcon.style.color = '#c0c0c0'; // Gray-300
                    } else {
                        dropdownArrowIcon.classList.add('text-gray-700');
                        dropdownArrowIcon.style.color = '';
                    }
                } else {
                    dropdownArrowIcon.classList.remove('text-gray-700');
                    dropdownArrowIcon.classList.add('text-white');
                    dropdownArrowIcon.style.color = '';
                }
            }

            // Update login/signup button style if it's visible
            if (loginSignupBtn && !loginSignupBtn.classList.contains('hidden')) {
                if (isScrolled) {
                    loginSignupBtn.classList.remove('text-white', 'border-white', 'hover:bg-white', 'hover:text-teal-600');
                    if (isDarkMode) {
                        loginSignupBtn.style.color = '#2dd4bf'; // Teal-400
                        loginSignupBtn.style.borderColor = '#2dd4bf'; // Teal-400
                        loginSignupBtn.classList.add('hover:bg-teal-50'); // Keep hover effect
                    } else {
                        loginSignupBtn.classList.add('text-teal-600', 'border-teal-600', 'hover:bg-teal-50');
                    }
                } else {
                    loginSignupBtn.classList.remove('text-teal-600', 'border-teal-600', 'hover:bg-teal-50');
                    loginSignupBtn.classList.add('text-white', 'border-white', 'hover:bg-white', 'hover:text-teal-600');
                }
            }
        }

        /**
         * Updates the header's authentication section based on user login status.
         * @param {Object|null} user - The Firebase User object or null if logged out.
         */
        async function updateAuthSection(user) {
            if (user) {
                // User is logged in
                loginSignupBtn.classList.add('hidden'); // 로그인/회원가입 버튼 숨김
                authSection.classList.remove('hidden'); // Ensure auth-section is visible
                userInfoDisplay.classList.remove('hidden'); // Show user info display
                userInfoDisplay.classList.add('flex'); // 레이아웃을 위해 flex로 설정

                // 닉네임을 가져오는 동안 "로딩 중..." 메시지 표시
                userNicknameSpan.textContent = '로딩 중...';

                // Firestore에서 사용자 닉네임 가져오기
                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/userProfiles`, user.uid);
                try {
                    const docSnap = await getDoc(userProfileRef);
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        // 닉네임이 존재하고 비어있지 않으면 닉네임 표시
                        if (userData.nickname && userData.nickname.trim() !== '') {
                            userNicknameSpan.textContent = userData.nickname;
                        } else {
                            // 닉네임이 없거나 비어있으면 이메일 표시 (또는 "사용자")
                            userNicknameSpan.textContent = user.email || '사용자';
                            console.warn("User profile found but nickname is empty or missing, displaying email:", user.uid);
                        }
                    } else {
                        // 사용자 프로필 문서가 없으면 이메일 표시 (또는 "사용자")
                        userNicknameSpan.textContent = user.email || '사용자';
                        console.warn("User profile document not found for:", user.uid);
                    }
                } catch (error) {
                    console.error("Error fetching user profile, displaying email:", error);
                    // 오류 발생 시 이메일 표시 (또는 "오류")
                    userNicknameSpan.textContent = user.email || '오류';
                }
            } else {
                // User is logged out
                loginSignupBtn.classList.remove('hidden'); // 로그인/회원가입 버튼 표시
                userInfoDisplay.classList.add('hidden'); // 사용자 정보 표시 숨김
                userInfoDisplay.classList.remove('flex');
                userNicknameSpan.textContent = ''; // 닉네임 지우기
                userDropdownMenu.classList.add('hidden'); // 드롭다운 메뉴 숨김
                if (dropdownArrowIcon) {
                    dropdownArrowIcon.classList.remove('rotate-180'); // 화살표 아이콘 회전 초기화
                }
            }
            // 가시성 업데이트 후 스크롤 기반 스타일 다시 적용
            handleScroll();
        }

        /**
         * Applies or removes dark mode based on the toggle state.
         * This function isF called on page load and when the dark mode toggle is changed.
         */
        function applyDarkModeToPage(isDarkMode) {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            // Re-apply scroll-based header styles after dark mode change
            handleScroll();
        }


        // Firebase 인증 상태 리스너
        onAuthStateChanged(auth, async (user) => {
            await updateAuthSection(user); // UI 업데이트
            if (user) {
                console.log("Authentication state changed: User is logged in.", user.uid);
            } else {
                console.log("Authentication state changed: User is logged out.");
                userNicknameSpan.textContent = '';
                userDropdownMenu.classList.add('hidden');
            }
            // 인증 상태와 관계없이 작품을 가져옵니다.
            fetchAndRenderAllWorks();
        });

        // 로그인/회원가입 버튼 클릭 핸들러
        loginSignupBtn.addEventListener('click', () => {
            window.location.href = 'login.html'; // 로그인 페이지로 리디렉션
        });

        // 드롭다운 토글 버튼 클릭 핸들러
        dropdownToggleBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            userDropdownMenu.classList.toggle('hidden');
            if (dropdownArrowIcon) {
                dropdownArrowIcon.classList.toggle('rotate-180');
            }
        });

        // 로그아웃 버튼 클릭 핸들러 (드롭다운 내부)
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
                // onAuthStateChanged 리스너에 의해 updateAuthSection이 호출될 것임
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });

        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', (event) => {
            if (!userDropdownMenu.contains(event.target) && !dropdownToggleBtn.contains(event.target)) {
                userDropdownMenu.classList.add('hidden');
                if (dropdownArrowIcon) {
                    dropdownArrowIcon.classList.remove('rotate-180');
                }
            }
        });


        // 이벤트 리스너
        window.addEventListener('load', async () => {
            // Firebase 인증 시도
            try {
                if (initialAuthToken) {
                    console.log("Attempting sign-in with custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token successfully.");
                } else {
                    console.log("No custom token found. User will be unauthenticated unless they log in.");
                }
            } catch (error) {
                console.error("Firebase authentication failed during initial sign-in attempt:", error);
                if (error.code === 'auth/custom-token-mismatch' || error.code === 'auth/invalid-custom-token') {
                    console.warn("Custom token mismatch/invalid. User will remain unauthenticated.");
                } else {
                    alert("Firebase 인증에 실패했습니다. 페이지 기능을 사용하려면 다시 시도해주세요.");
                }
                updateAuthSection(null);
            }

            // 다크 모드 설정 불러오기
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                applyDarkModeToPage(savedDarkMode === 'true');
            }

            handleScroll(); // 초기 헤더 스타일 설정
            // fetchAndRenderAllWorks는 onAuthStateChanged에서 호출되므로 여기서 직접 호출할 필요 없습니다.
        });

        window.addEventListener('scroll', handleScroll);
        prevBannerBtn.addEventListener('click', handlePrevBanner);
        nextBannerBtn.addEventListener('click', handleNextBanner);

        heroSection.addEventListener('touchstart', handleTouchStart);
        heroSection.addEventListener('touchmove', handleTouchMove);
        heroSection.addEventListener('touchend', handleTouchEnd);

        // Event listeners for popular works tabs (updated selectors)
        const popularTabsContainer = document.querySelector('.flex.space-x-4.mb-6.border-b.border-gray-200');
        if (popularTabsContainer) {
            popularTabsContainer.querySelectorAll('button[data-tab]').forEach(button => {
                button.addEventListener('click', (event) => {
                    // Remove active state from all tabs in this container
                    popularTabsContainer.querySelectorAll('button[data-tab]').forEach(btn => {
                        btn.classList.remove('text-teal-600', 'border-b-2', 'border-teal-600');
                        btn.classList.add('text-gray-600', 'hover:text-teal-600');
                    });
                    // Add active state to clicked tab
                    event.target.classList.add('text-teal-600', 'border-b-2', 'border-teal-600');
                    event.target.classList.remove('text-gray-600', 'hover:text-teal-600');

                    // Determine sort field based on the data-tab attribute
                    let firestoreSortField = 'views'; // Default to views
                    switch (event.target.dataset.tab) {
                        case '실시간':
                        case '이번 주':
                            firestoreSortField = 'views'; // Map to views
                            break;
                        case '분기':
                        case '역대':
                            firestoreSortField = 'likes'; // Map to likes
                            break;
                        default:
                            firestoreSortField = 'views'; // Fallback
                    }
                    // Re-fetch and render popular works based on the selected tab
                    const worksCollectionRef = collection(db, `artifacts/${appId}/public/data/works`);
                    const popularWorksQuery = query(worksCollectionRef, orderBy(firestoreSortField, 'desc'), limit(10));
                    onSnapshot(popularWorksQuery, (snapshot) => {
                        const popularWorks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderWorkCards(popularWorksContainer, popularWorks, 'popular');
                    }, (error) => {
                        console.error(`Error fetching popular works by ${firestoreSortField}:`, error);
                        popularWorksContainer.innerHTML = '<p class="text-red-500">인기 작품을 불러오는 데 실패했습니다.</p>';
                    });
                });
            });
        }
    </script>
</body>
</html>
